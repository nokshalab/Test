<!DOCTYPE html>

<html lang="bn">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="./logo.png" rel="icon" type="image/x-icon"/>
<title>B-Baria Telecom - Admin Panel</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Font Awesome for Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<!-- Google Fonts (Hind Siliguri for Bangla & Poppins for English) -->
<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&amp;family=Poppins:wght@300;400;500;600&amp;display=swap" rel="stylesheet"/>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Hind Siliguri"', 'sans-serif'],
                        english: ['"Poppins"', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                            600: '#475569'
                        },
                        accent: {
                            DEFAULT: '#3b82f6',
                            hover: '#2563eb'
                        }
                    }
                }
            }
        }
    </script>
<style>
        body {
            background-color: #0f172a; 
            color: #e2e8f0; 
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
        .hidden-section {
            display: none;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Drag and Drop Styles */
        .draggable-item {
            cursor: move;
            transition: all 0.2s ease;
        }
        .draggable-item.dragging {
            opacity: 0.5;
            background: #334155 !important;
            border: 2px dashed #3b82f6;
            transform: scale(0.98);
        }
        /* Custom Checkbox Style */
        .custom-checkbox input:checked + div {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox input:checked + div svg {
            display: block;
        }
        /* Active Card Style */
        .card-active-stock { border-color: #f97316 !important; background-color: rgba(249, 115, 22, 0.1) !important; }
        .card-active-balance { border-color: #3b82f6 !important; background-color: rgba(59, 130, 246, 0.1) !important; }
        .card-active-cash { border-color: #22c55e !important; background-color: rgba(34, 197, 94, 0.1) !important; }
        /* Active Profit Card Style */
        .card-active-profit { border-color: #a855f7 !important; background-color: rgba(168, 85, 247, 0.1) !important; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        
        /* Account Badge Styles */
        .badge-bkash { background-color: #e2136e; color: white; }
        .badge-nagad { background-color: #f16124; color: white; }
        .badge-rocket { background-color: #8c3494; color: white; }
        .badge-upay { background-color: #0081c7; color: white; }
        .badge-desco { background-color: #009c48; color: white; }
        /* NEW Badges */
        .badge-gp { background-color: #00699e; color: white; } /* Grameen Blue */
        .badge-bl { background-color: #ff6b00; color: white; } /* Banglalink Orange */
        .badge-robi { background-color: #ed1c24; color: white; } /* Robi Red */
        .badge-airtel { background-color: #d60d16; color: white; } /* Airtel Red */
        
        .badge-default { background-color: #475569; color: #e2e8f0; }

        /* Hide scrollbar for nav */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* --- MOBILE CLOCK POPUP CSS --- */
        @media (max-width: 480px) {
            #main-clock-container.mobile-active {
                display: flex !important;
                position: fixed !important;
                top: 75px !important; /* নেভিগেশন বারের ঠিক নিচে */
                left: 50% !important;
                transform: translateX(-50%) !important;
                z-index: 1000 !important;
                width: auto !important;
                background: rgba(15, 23, 42, 0.95) !important;
                border: 1px solid rgba(59, 130, 246, 0.5) !important;
                border-radius: 20px !important;
                box-shadow: 0 10px 30px rgba(0,0,0,0.6) !important;
                padding: 5px 15px !important;
                backdrop-filter: blur(10px);
                animation: clockSlideDown 0.3s ease-out;
            }
            #main-clock-container.mobile-active .bg-dark-900\/80 {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
            }
        }

        @keyframes clockSlideDown {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
<!-- Navigation Bar -->
<nav class="sticky top-0 z-50 glass-panel border-b border-gray-700 shadow-lg relative">
<div class="container mx-auto px-4 py-3 flex justify-between items-center relative">
<!-- Left: Logo -->
<div class="flex items-center gap-3 cursor-pointer z-10">
<div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">
<i class="fa-solid fa-shield-halved"></i>
</div>
<div>
<h1 class="text-2xl font-bold tracking-wide text-white">B - <span class="text-blue-500">Baria</span></h1>
<p class="text-xs text-gray-400 -mt-1 uppercase tracking-wider">Admin Panel</p>
</div>
</div>
<!-- Center: Live Clock -->
<div class="hidden lg:flex absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 z-0" id="main-clock-container">
<div class="flex items-center gap-3 bg-dark-900/80 border border-gray-700/50 px-5 py-2 rounded-full shadow-inner backdrop-blur-md">
<div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
<div class="text-center">
<p class="text-[10px] text-gray-400 font-medium tracking-wide uppercase leading-none mb-0.5" id="live-date">...</p>
<p class="text-sm font-bold text-white tracking-widest font-mono leading-none" id="live-time">...</p>
</div>
</div>
</div>
<!-- Right: Actions -->
<div class="flex items-center gap-3 z-10">
<!-- History Button -->
<button class="hidden w-9 h-9 rounded-full bg-gray-800 text-purple-400 hover:text-white hover:bg-purple-600 border border-gray-600 flex items-center justify-center transition shadow-lg" id="history-btn" onclick="openHistoryModal()" title="লেনদেনের ইতিহাস">
<i class="fa-solid fa-clock-rotate-left"></i>
</button>
<!-- Settings Button -->
<button class="hidden w-9 h-9 rounded-full bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700 border border-gray-600 flex items-center justify-center transition shadow-lg" id="settings-btn" onclick="openSettingsModal()" title="টিম ও ডাটাবেজ সেটিংস">
<i class="fa-solid fa-gear"></i>
</button>
<!-- Logout Button -->
<button class="hidden text-red-400 hover:text-red-300 text-sm font-medium border border-red-500/30 px-3 py-1.5 rounded hover:bg-red-500/10 transition flex items-center shadow-lg" id="logout-btn" onclick="logout()">
<i class="fa-solid fa-sign-out-alt mr-1"></i> <span class="hidden md:inline ml-1">লগআউট</span>
</button><button class="hidden text-red-400 hover:text-red-300 text-sm font-medium border border-red-500/30 px-3 py-1.5 rounded hover:bg-red-500/10 transition flex items-center shadow-lg" id="clock-toggle-btn" style="display:none;">⏰</button>
</div>
</div>
</nav>
<!-- Main Content Area -->
<main class="flex-grow container mx-auto px-4 py-6">
<div class="fixed top-20 right-5 z-50 hidden p-4 rounded-lg shadow-xl text-white transform transition-all duration-300 border border-gray-600" id="toast"></div>
<div class="fixed bottom-5 left-5 z-40 bg-dark-800 px-3 py-2 rounded-lg border border-gray-700 text-xs text-gray-400 flex flex-col gap-1 hidden shadow-lg" id="firebase-status">
<div class="flex items-center gap-2">
<div class="w-2 h-2 rounded-full bg-gray-500" id="master-indicator"></div>
<span id="master-text">Master: Off</span>
</div>
<div class="flex items-center gap-2">
<div class="w-2 h-2 rounded-full bg-gray-500" id="active-indicator"></div>
<span id="active-text">Active: Local</span>
</div>
</div>
<!-- SECTION: Admin Login Modal -->
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm" id="modal-login">
<div class="glass-panel p-8 rounded-xl w-full max-w-md mx-4 shadow-2xl transform transition-all scale-100 border-t-4 border-blue-600">
<div class="text-center mb-6">
<div class="w-16 h-16 bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/50">
<i class="fa-solid fa-user-lock text-3xl text-blue-500"></i>
</div>
<h3 class="text-2xl font-bold text-white">এডমিন লগইন</h3>
<p class="text-gray-400 text-sm mt-2">দোকান পরিচালনার ড্যাশবোর্ডে প্রবেশ করতে পাসওয়ার্ড দিন</p>
</div>
<div class="space-y-4">
<div>
<label class="block text-gray-400 text-sm mb-1">পাসওয়ার্ড</label>
<input class="w-full bg-dark-900 border border-gray-600 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none" id="admin-password" placeholder="পাসওয়ার্ড দিন" type="password"/>
</div>
<button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg" onclick="performLogin()">
                        লগইন করুন
                    </button>
</div>
</div>
</div>
<!-- SECTION: Admin Dashboard & Management -->
<section class="hidden-section fade-in" id="section-admin">
<!-- Stats Cards Container (Navigation) -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8" id="admin-stats-container">
<!-- Cards will be injected here via JS -->
</div>
<!-- VIEW: Products List -->
<div class="glass-panel rounded-xl p-6 mb-8 animate-fade-in" id="view-products">
<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
<h3 class="text-xl font-bold text-white border-l-4 border-orange-500 pl-3">সার্ভিস ও প্রোডাক্ট তালিকা</h3>
<div class="flex gap-2 w-full md:w-auto">
<div class="relative w-full">
<input class="w-full bg-dark-900 border border-gray-600 rounded-lg py-2 px-4 focus:outline-none text-white text-sm" id="admin-search" oninput="renderAdminItems()" placeholder="প্রোডাক্ট খুঁজুন..." type="text"/>
</div>
<button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg whitespace-nowrap shadow-lg text-sm font-medium" onclick="openItemModal()">
<i class="fa-solid fa-plus"></i> নতুন যুক্ত করুন
                        </button>
</div>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left border-collapse">
<thead>
<tr class="text-gray-400 border-b border-gray-700 text-sm font-bold bg-dark-800">
<th class="p-4">নাম</th>
<th class="p-4">ক্যাটাগরি</th>
<th class="p-4">কেনা দাম</th>
<th class="p-4">বিক্রয় মূল্য</th>
<th class="p-4">স্টক</th>
<th class="p-4 text-center">বিক্রয় (কুইক)</th>
<th class="p-4 text-right">অ্যাকশন</th>
</tr>
</thead>
<tbody class="text-gray-300 text-sm" id="admin-items-body"></tbody>
</table>
</div>
</div>
<!-- VIEW: Accounts List (UPDATED with Navigation) -->
<div class="glass-panel rounded-xl p-6 mb-8 hidden animate-fade-in relative" id="view-accounts">
<div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
<h3 class="text-xl font-bold text-white border-l-4 border-blue-500 pl-3">অ্যাকাউন্ট তালিকা</h3>
<button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg whitespace-nowrap shadow-lg text-sm font-medium md:hidden w-full" onclick="openAccountFormModal()">
<i class="fa-solid fa-plus"></i> নতুন যুক্ত করুন
                    </button>
</div>
<!-- NEW: Account Type Navigation -->
<div class="flex overflow-x-auto gap-2 mb-4 pb-2 border-b border-gray-700 no-scrollbar items-center" id="account-nav-container">
<!-- Nav items injected via JS -->
</div>
<div class="flex gap-2 w-full mb-4">
<div class="relative w-full">
<input class="w-full bg-dark-900 border border-gray-600 rounded-lg py-2 px-4 focus:outline-none text-white text-sm" id="account-search" oninput="renderAccountsList()" placeholder="অ্যাকাউন্ট খুঁজুন..." type="text"/>
</div>
<button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg whitespace-nowrap shadow-lg text-sm font-medium hidden md:block" onclick="openAccountFormModal()">
<i class="fa-solid fa-plus"></i> নতুন যুক্ত করুন
                    </button>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left border-collapse">
<thead>
<tr class="text-gray-400 border-b border-gray-700 text-sm font-bold uppercase bg-dark-800">
<th class="p-4">অ্যাকাউন্টের নাম</th>
<th class="p-4 text-center">ধরন</th>
<th class="p-4 text-right">বর্তমান ব্যালেন্স</th>
<th class="p-4 text-center">লেনদেন</th>
<th class="p-4 text-right">অ্যাকশন</th>
</tr>
</thead>
<tbody class="text-gray-300 text-sm" id="accounts-list-body"></tbody>
<tfoot class="border-t border-gray-700 bg-dark-800">
<tr><td class="p-4 font-bold text-white">মোট ব্যালেন্স</td><td colspan="1"></td><td class="p-4 text-right font-bold text-blue-400" id="view-total-balance">৳ 0</td><td colspan="2"></td></tr>
</tfoot>
</table>
</div>
<!-- DESCO INTERFACE CONTAINER (Inline Section) -->
<div class="mt-6 bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden hidden animate-fade-in text-gray-800" id="desco-transaction-panel">
<!-- Desco UI will be rendered here via JS -->
</div>
</div>
<!-- VIEW: Cash Management -->
<div class="glass-panel rounded-xl p-6 mb-8 hidden animate-fade-in" id="view-cash">
<div class="mb-6">
<h3 class="text-xl font-bold text-white border-l-4 border-green-500 pl-3">ক্যাশ ম্যানেজমেন্ট</h3>
<p class="text-gray-400 text-sm mt-1 pl-4">সরাসরি ক্যাশ টাকা জমা বা উত্তোলনের হিসাব রাখুন</p>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
<!-- Form Section -->
<div class="bg-dark-800 p-6 rounded-xl border border-gray-700 shadow-lg">
<label class="text-sm text-gray-400 block mb-2 font-medium">টাকার পরিমাণ</label>
<div class="relative mb-4">
<span class="absolute left-3 top-3 text-gray-500">৳</span>
<input class="w-full bg-dark-900 border border-gray-600 rounded-lg py-3 pl-8 pr-4 text-white focus:border-green-500 focus:outline-none text-lg font-bold" id="manage-cash-amount" placeholder="0" type="number"/>
</div>
<label class="text-sm text-gray-400 block mb-2 font-medium">বিবরণ / কারণ (ঐচ্ছিক)</label>
<input class="w-full bg-dark-900 border border-gray-600 rounded-lg py-3 px-4 text-white focus:border-green-500 focus:outline-none mb-6" id="manage-cash-desc" placeholder="যেমন: ব্যক্তিগত খরচ, বাসা থেকে আনা..." type="text"/>
<div class="flex gap-4 mb-4">
<button class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold transition text-sm flex items-center justify-center gap-2 shadow-md" onclick="submitCashTransaction('add')">
<i class="fa-solid fa-circle-plus"></i> জমা করুন
                            </button>
<button class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold transition text-sm flex items-center justify-center gap-2 shadow-md" onclick="submitCashTransaction('withdraw')">
<i class="fa-solid fa-circle-minus"></i> উত্তোলন করুন
                            </button>
</div>
<button class="w-full bg-orange-600/20 hover:bg-orange-600 hover:text-white text-orange-500 border border-orange-600/50 py-2 rounded-lg font-medium transition text-xs mt-2" onclick="resetCash()">
<i class="fa-solid fa-arrows-rotate mr-1"></i> ক্যাশ রিসেট (০ করুন)
                        </button>
</div>
<!-- Info/Tip Section -->
<div class="bg-blue-900/10 p-6 rounded-xl border border-blue-500/20 text-center flex flex-col items-center justify-center h-full">
<div class="w-16 h-16 bg-green-900/30 rounded-full flex items-center justify-center mb-4 border border-green-500/30">
<i class="fa-solid fa-wallet text-3xl text-green-500"></i>
</div>
<h4 class="text-lg font-bold text-white mb-2">বর্তমান ক্যাশ ব্যালেন্স</h4>
<p class="text-3xl font-bold text-green-400 mb-4" id="view-cash-display">৳ 0</p>
<p class="text-xs text-gray-400 leading-relaxed">
                            এখানে টাকা জমা দিলে তা মূলধনের সাথে যুক্ত হবে। উত্তোলন করলে ক্যাশ থেকে কমে যাবে।<br/>
                            লেনদেনের বিবরণ হিস্টোরিতে সংরক্ষিত থাকবে।
                        </p>
</div>
</div>
</div>
<!-- VIEW: Profit Management -->
<div class="glass-panel rounded-xl p-6 mb-8 hidden animate-fade-in" id="view-profit">
<div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
<div>
<h3 class="text-xl font-bold text-white border-l-4 border-purple-500 pl-3">লাভের হিসাব (Profit Tracker)</h3>
<p class="text-gray-400 text-sm mt-1 pl-4">দিন, সপ্তাহ, মাস ও বছরের লাভের বিস্তারিত হিসাব</p>
</div>
<div class="flex items-center gap-3">
<div class="text-sm text-gray-400 bg-dark-900 px-3 py-1 rounded border border-gray-700">
<span class="w-2 h-2 rounded-full bg-green-500 inline-block mr-1 animate-pulse"></span> অটোমেটিক ট্র্যাকিং অন
                         </div>
</div>
</div>
<!-- Toggle/Display Control -->
<div class="bg-dark-800 p-4 rounded-lg border border-gray-700 mb-6">
<h4 class="text-sm font-bold text-gray-300 mb-3"><i class="fa-solid fa-eye mr-1"></i> ড্যাশবোর্ড কার্ডে কোনটি দেখাতে চান?</h4>
<div class="flex flex-wrap gap-4" id="profit-toggle-container">
<!-- Radio buttons generated by JS -->
</div>
</div>
<!-- Profit Cards Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="profit-cards-grid">
<!-- Cards generated by JS -->
</div>
<!-- Total Actions -->
<div class="bg-purple-900/10 border border-purple-500/20 p-4 rounded-lg flex flex-col md:flex-row justify-between items-center gap-4">
<div>
<p class="text-purple-300 font-bold text-lg">সর্বমোট লাভ (All Time)</p>
<p class="text-xs text-gray-400">শুরু থেকে এখন পর্যন্ত মোট লাভ</p>
</div>
<div class="text-3xl font-bold text-white" id="profit-all-time-display">৳ 0</div>
<button class="bg-red-600/80 hover:bg-red-600 text-white px-4 py-2 rounded text-sm font-bold transition" onclick="confirmResetProfit()">
<i class="fa-solid fa-trash-arrow-up mr-1"></i> সব রিসেট করুন
                    </button>
</div>
</div>
</section>
</main>
<!-- Updated Footer -->
<footer class="bg-dark-800 border-t border-gray-700 pt-10 pb-6 mt-auto">
<div class="container mx-auto px-4">
<div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center text-center md:text-left">
<!-- Brand & Quote -->
<div class="space-y-3">
<div class="flex items-center justify-center md:justify-start gap-2">
<div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white">
<i class="fa-solid fa-shield-halved"></i>
</div>
<h4 class="text-xl font-bold text-white tracking-wide">B-Baria Telecom</h4>
</div>
<p class="text-gray-400 text-sm italic font-english">
                        "Success isn't just about what you accomplish in your life; it's about what you inspire others to do."
                    </p>
</div>
<!-- Social Links -->
<div class="flex flex-col items-center">
<h4 class="text-white font-bold mb-4 text-sm uppercase tracking-widest text-blue-400">Connect With Us</h4>
<div class="flex gap-4">
<a class="w-10 h-10 rounded-full bg-blue-600/20 text-blue-500 border border-blue-600/50 flex items-center justify-center hover:bg-blue-600 hover:text-white transition duration-300 transform hover:-translate-y-1" href="https://facebook.com" target="_blank">
<i class="fa-brands fa-facebook-f text-lg"></i>
</a>
<a class="w-10 h-10 rounded-full bg-red-600/20 text-red-500 border border-red-600/50 flex items-center justify-center hover:bg-red-600 hover:text-white transition duration-300 transform hover:-translate-y-1" href="https://youtube.com" target="_blank">
<i class="fa-brands fa-youtube text-lg"></i>
</a>
<a class="w-10 h-10 rounded-full bg-green-500/20 text-green-500 border border-green-500/50 flex items-center justify-center hover:bg-green-500 hover:text-white transition duration-300 transform hover:-translate-y-1" href="https://whatsapp.com" target="_blank">
<i class="fa-brands fa-whatsapp text-lg"></i>
</a>
</div>
</div>
<!-- Copyright -->
<div class="text-gray-500 text-sm md:text-right">
<p>© 2024 Noksha Lab.</p>
<p class="text-xs mt-1">Developed for B-Baria Telecom</p>
<p class="text-[10px] mt-1 opacity-50 font-english">v2.8.0 Stable</p>
</div>
</div>
</div>
</footer>
<!-- MODALS -->
<!-- Account Type Settings Modal -->
<div class="fixed inset-0 z-[70] flex items-center justify-center bg-black bg-opacity-90 hidden backdrop-blur-sm" id="modal-type-settings">
<div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4 border border-purple-500/30">
<h3 class="text-lg font-bold text-white mb-2"><span class="text-purple-400" id="type-settings-name"></span> সেটিংস</h3>
<p class="text-xs text-gray-400 mb-4">এই অ্যাকাউন্টের ধরণ অনুযায়ী অটোমেটিক লাভের হিসাব সেট করুন</p>
<input id="setting-type-key" type="hidden"/>
<!-- Generic Fields -->
<div class="space-y-3" id="settings-generic-fields">
<div>
<label class="text-xs text-gray-400 block mb-1">ক্যাশ আউট খরচ (প্রতি হাজারে)</label>
<input class="input-field text-sm" id="setting-cashout-cost" placeholder="18.5" type="number"/>
</div>
<div>
<label class="text-xs text-gray-400 block mb-1">সেন্ড মানি খরচ (প্রতি হাজারে)</label>
<input class="input-field text-sm" id="setting-send-cost" placeholder="5" type="number"/>
</div>
<div>
<label class="text-xs text-gray-400 block mb-1">কমিশন / লাভ (শতাংশ %)</label>
<input class="input-field text-sm" id="setting-commission" placeholder="2.5" type="number"/>
<p class="text-[10px] text-gray-500 mt-1">রিচার্জ বা ক্যাশ ইনের ক্ষেত্রে প্রযোজ্য</p>
</div>
</div>
<!-- Desco Specific Fields (Hidden by default) -->
<div class="space-y-3 hidden" id="settings-desco-fields">
<div>
<label class="text-xs text-gray-400 block mb-1">কাস্টমার ফি (প্রতি হাজারে)</label>
<input class="input-field text-sm" id="setting-desco-fee" placeholder="10" type="number"/>
<p class="text-[10px] text-gray-500 mt-1">যেমন: ১০০০ টাকার জন্য ১০ টাকা লাভ (স্ল্যাব ভিত্তিক)</p>
</div>
<div>
<label class="text-xs text-gray-400 block mb-1">কোম্পানি চার্জ (প্রতি হাজারে)</label>
<input class="input-field text-sm" id="setting-desco-cost" placeholder="2.5" type="number"/>
<p class="text-[10px] text-gray-500 mt-1">কোম্পানি যা কাটবে (যেমন ২.৫০ টাকা)</p>
</div>
<div>
<label class="text-xs text-gray-400 block mb-1">সর্বনিম্ন রিচার্জ লিমিট</label>
<input class="input-field text-sm" id="setting-desco-min" placeholder="100" type="number"/>
</div>
</div>
<div class="flex gap-3 mt-6">
<button class="flex-1 bg-purple-600 text-white py-2 rounded font-bold hover:bg-purple-700 text-sm" onclick="saveTypeSettings()">সেভ করুন</button>
<button class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700 text-sm" onclick="closeModal('modal-type-settings')">বাতিল</button>
</div>
</div>
</div>
<!-- History Modal -->
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm" id="modal-history">
<div class="glass-panel p-6 rounded-xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto border-l-4 border-purple-500">
<div class="flex justify-between items-center mb-6">
<div>
<h3 class="text-xl font-bold text-white"><i class="fa-solid fa-clock-rotate-left mr-2"></i> লেনদেনের ইতিহাস (History)</h3>
<p class="text-sm text-gray-400 mt-1">প্রতিটি কাজের পরিমাণ, খরচ এবং লাভের বিস্তারিত হিসাব</p>
</div>
<div class="flex gap-2">
<button class="text-red-400 border border-red-500 px-3 py-1 rounded hover:bg-red-500 hover:text-white transition text-sm flex items-center gap-1 font-medium" onclick="resetHistory()">
<i class="fa-solid fa-trash-can"></i> পুরো রিসেট
                    </button>
<button class="text-gray-400 hover:text-white text-2xl ml-2" onclick="closeModal('modal-history')"><i class="fa-solid fa-times"></i></button>
</div>
</div>
<div class="overflow-x-auto max-h-[60vh] overflow-y-auto bg-dark-900 rounded-lg border border-gray-700">
<table class="w-full text-left border-collapse">
<thead class="sticky top-0 bg-dark-800 z-10 shadow-md">
<tr class="text-gray-400 border-b border-gray-700 text-sm font-bold uppercase">
<th class="p-4"><i class="fa-regular fa-calendar mr-1"></i> তারিখ</th>
<th class="p-4">কাজের বিবরণ</th>
<th class="p-4 text-center">পরিমাণ</th>
<th class="p-4 text-right">খরচ (Cost)</th>
<th class="p-4 text-right">বিক্রয় (Sale)</th>
<th class="p-4 text-right">লাভ (Profit)</th>
<th class="p-4 text-right">অ্যাকশন</th>
</tr>
</thead>
<tbody class="text-gray-300 text-sm" id="history-body"></tbody>
</table>
</div>
<button class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded mt-4 font-bold text-sm" onclick="closeModal('modal-history')">বন্ধ করুন</button>
</div>
</div>
<!-- Settings Modal (Team & Database) + Danger Zone -->
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm" id="modal-settings">
<div class="glass-panel p-6 rounded-xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
<h3 class="text-2xl font-bold text-white"><i class="fa-solid fa-gear mr-2 text-gray-400"></i> সেটিংস (টিম ও ডাটাবেজ)</h3>
<button class="text-gray-400 hover:text-white text-xl" onclick="closeModal('modal-settings')"><i class="fa-solid fa-times"></i></button>
</div>
<!-- Database Content -->
<div class="animate-fade-in" id="db-settings-content">
<!-- STEP 1: Hardcoded Master DB Info -->
<div class="mb-4 p-3 bg-purple-900/30 border border-purple-700 rounded-lg text-sm text-purple-300">
<i class="fa-solid fa-server mr-2"></i> মাস্টার ডাটাবেজ অটোমেটিক কানেক্টেড (বিল্ট-ইন)।
                </div>
<!-- STEP 2: Share Own Config -->
<div class="mb-6 border-b border-gray-700 pb-6">
<h3 class="font-bold text-lg mb-2 text-blue-400">১. ডাটাবেজ শেয়ার ও এডিট</h3>
<p class="text-sm text-gray-400 mb-3">নতুন ডাটাবেজ যুক্ত করুন অথবা তালিকা থেকে এডিট বাটনে ক্লিক করে তথ্য আপডেট করুন।</p>
<input id="share-doc-id" type="hidden"/> <!-- Hidden ID field for updates -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
<input class="input-field" id="share-name" placeholder="আপনার নাম (উদাঃ মিজান)" type="text"/>
<input class="input-field" id="share-email" placeholder="আপনার ইমেইল" type="email"/>
</div>
<textarea class="bg-dark-900 border border-gray-600 rounded p-2 text-sm text-white w-full h-16 font-mono text-xs mb-2" id="share-config" placeholder="আপনার Firebase Config JSON..."></textarea>
<div class="flex gap-2">
<button class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 w-full font-medium" id="btn-share-config" onclick="shareMyConfig()">শেয়ার করুন</button>
<button class="bg-gray-600 text-white px-4 py-2 rounded text-sm hover:bg-gray-700 hidden" id="btn-reset-share" onclick="resetShareForm()">বাতিল</button>
</div>
</div>
<!-- STEP 3: Active Database Selection -->
<div class="mb-8">
<h3 class="font-bold text-lg mb-2 text-green-400">২. অ্যাক্টিভ ডাটাবেজ নির্বাচন করুন</h3>
<p class="text-sm text-gray-400 mb-3">যেকোনো একটি কনফিগারেশন সিলেক্ট করুন। <br/><span class="text-yellow-400">টিপস:</span> ড্রাগ করে পছন্দের ডাটাবেজটিকে সবার উপরে রাখুন।</p>
<div class="bg-dark-900 rounded-lg p-2 max-h-60 overflow-y-auto" id="team-config-list">
<div class="text-center text-gray-500 py-4 text-sm"><i class="fa-solid fa-spinner fa-spin"></i> মাস্টার ডাটাবেজ লোড হচ্ছে...</div>
</div>
</div>
</div>
<!-- SEPARATOR -->
<hr class="border-gray-700 my-6"/>
<!-- DANGER ZONE (Moved Here) -->
<div class="glass-panel rounded-xl p-6 border border-red-900/50 bg-red-900/10">
<h3 class="text-xl font-bold text-red-400 mb-2"><i class="fa-solid fa-triangle-exclamation mr-2"></i> ডেঞ্জার জোন (Danger Zone)</h3>
<p class="text-gray-400 text-sm mb-4">সতর্কতা: এখান থেকে আপনি ডাটাবেজের তথ্য মুছে ফেলতে পারেন। বুঝে শুনে ক্লিক করুন।</p>
<div class="flex flex-col md:flex-row gap-4">
<button class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg flex items-center justify-center gap-2 transition hover:scale-105 text-sm" onclick="openHardResetModal()">
<i class="fa-solid fa-skull-crossbones"></i> কাস্টম রিসেট (Custom Reset)
                    </button>
<p class="text-sm text-gray-500 self-center">এই বাটনে ক্লিক করে আপনি বেছে নিতে পারবেন কোন ডাটাগুলো (হিস্ট্রি, অ্যাকাউন্ট, সার্ভিস) আপনি ডিলিট করতে চান।</p>
</div>
</div>
<button class="w-full bg-gray-700 hover:bg-gray-600 text-white py-2 rounded mt-6 font-bold text-sm" onclick="closeModal('modal-settings')">বন্ধ করুন</button>
</div>
</div>
<!-- Manage Cash Modal -->
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm" id="modal-manage-cash">
<div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4">
<!-- Modal logic moved to view-cash in dashboard -->
</div>
</div>
<!-- Manage Accounts Modal -->
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm" id="modal-manage-accounts">
<!-- Modal logic moved to view-accounts in dashboard -->
</div>
<!-- Account Form Modal -->
<div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-90 hidden backdrop-blur-sm" id="modal-account-form">
<div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4 border border-blue-500/30">
<h3 class="text-lg font-bold text-white mb-4" id="account-form-title">নতুন অ্যাকাউন্ট</h3>
<input id="account-id" type="hidden"/>
<label class="text-sm text-gray-400 block mb-1">অ্যাকাউন্টের নাম</label>
<input class="input-field mb-4" id="account-name" placeholder="যেমন: বিকাশ এজেন্ট, রকেট পার্সোনাল" type="text"/>
<label class="text-sm text-gray-400 block mb-1">অ্যাকাউন্টের ধরন</label>
<select class="input-field mb-4 cursor-pointer" id="account-type">
<option value="Desco">Desco</option>
<option value="Bkash">Bkash</option>
<option value="Nagad">Nagad</option>
<option value="Rocket">Rocket</option>
<option value="Upay">Upay</option>
<option value="GP">GP (Grameenphone)</option>
<option value="BL">BL (Banglalink)</option>
<option value="Robi">Robi</option>
<option value="Airtel">Airtel</option>
</select>
<div id="initial-balance-div">
<label class="text-sm text-gray-400 block mb-1">শুরুর ব্যালেন্স</label>
<input class="input-field mb-4" id="account-initial-balance" placeholder="0" type="number"/>
</div>
<div class="flex gap-3">
<button class="flex-1 bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 text-sm" onclick="saveAccount()">সেভ করুন</button>
<button class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700 text-sm" onclick="closeModal('modal-account-form')">বাতিল</button>
</div>
</div>
</div>
<!-- Account Transaction Modal -->
<div class="fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-90 hidden backdrop-blur-sm" id="modal-account-transact">
<div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4 border border-green-500/30">
<h3 class="text-lg font-bold text-white mb-2" id="transact-account-name">লেনদেন করুন</h3>
<p class="text-sm text-gray-400 mb-4">এই অ্যাকাউন্টে টাকা জমা বা উত্তোলন করুন</p>
<input id="transact-account-id" type="hidden"/>
<label class="text-sm text-gray-400 block mb-1">টাকার পরিমাণ</label>
<input class="input-field mb-3" id="transact-amount" placeholder="0" type="number"/>
<label class="text-sm text-gray-400 block mb-1">বিবরণ (ঐচ্ছিক)</label>
<input class="input-field mb-4" id="transact-desc" placeholder="যেমন: লোড নেওয়া হলো" type="text"/>
<div class="flex gap-3">
<button class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded font-bold transition flex justify-center items-center gap-1 text-sm" onclick="submitAccountTransaction('deposit')"><i class="fa-solid fa-plus"></i> জমা</button>
<button class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded font-bold transition flex justify-center items-center gap-1 text-sm" onclick="submitAccountTransaction('withdraw')"><i class="fa-solid fa-minus"></i> খরচ/নেওয়া</button>
</div>
<button class="w-full mt-3 text-gray-500 text-sm hover:text-white" onclick="closeModal('modal-account-transact')">বন্ধ করুন</button>
</div>
</div>
<!-- Desco Balance Correction Modal -->
<div class="fixed inset-0 z-[80] flex items-center justify-center bg-black bg-opacity-90 hidden backdrop-blur-sm" id="modal-desco-correct">
<div class="glass-panel p-6 rounded-xl w-full max-w-xs mx-4 border-t-4 border-blue-500">
<h3 class="text-lg font-bold text-white mb-2">ব্যালেন্স সংশোধন</h3>
<p class="text-xs text-gray-400 mb-4">ভুল হলে এখানে সঠিক বর্তমান ব্যালেন্সটি লিখুন।</p>
<input class="input-field mb-4" id="desco-correct-amount" placeholder="বর্তমান ব্যালেন্স" type="number"/>
<div class="flex gap-3">
<button class="flex-1 bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 text-sm" onclick="submitDescoCorrection()">আপডেট</button>
<button class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700 text-sm" onclick="closeModal('modal-desco-correct')">বাতিল</button>
</div>
</div>
</div>
<!-- Desco Load Balance Modal -->
<div class="fixed inset-0 z-[80] flex items-center justify-center bg-black bg-opacity-90 hidden backdrop-blur-sm" id="modal-desco-load">
<div class="glass-panel p-6 rounded-xl w-full max-w-xs mx-4 border-t-4 border-green-500">
<h3 class="text-lg font-bold text-white mb-2">ব্যালেন্স লোড করুন</h3>
<p class="text-xs text-gray-400 mb-4">ক্যাশ থেকে টাকা কেটে ডেসকো ব্যালেন্সে যুক্ত হবে।</p>
<input class="input-field mb-4" id="desco-load-amount" placeholder="টাকার পরিমাণ" type="number"/>
<div class="flex gap-3">
<button class="flex-1 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700 text-sm" onclick="submitDescoLoad()">নিশ্চিত করুন</button>
<button class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700 text-sm" onclick="closeModal('modal-desco-load')">বাতিল</button>
</div>
</div>
</div>
<!-- Quick Sale Modal -->
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm" id="modal-quicksale">
<div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4">
<h3 class="text-lg font-bold text-white mb-4">কাজের পরিমাণ ও দাম নির্ধারণ</h3>
<div class="bg-dark-900 p-3 rounded mb-4 border border-gray-700">
<p class="text-blue-400 font-bold mb-1" id="qs-name"></p>
<div class="flex justify-between text-sm text-gray-400">
<span>ফিক্সড প্রাইস: <span class="text-white" id="qs-price"></span></span>
<span>কেনা দাম: <span class="text-white" id="qs-cost"></span></span>
</div>
</div>
<div class="grid grid-cols-2 gap-3 mb-4">
<div>
<label class="text-sm text-gray-400 block mb-1">পরিমাণ (Qty)</label>
<input class="input-field text-center font-bold" id="qs-qty" min="1" oninput="updateQSPreview()" type="number" value="1"/>
</div>
<div>
<label class="text-sm text-gray-400 block mb-1">বিক্রয় মূল্য (একক)</label>
<input class="input-field text-center font-bold border-blue-500" id="qs-custom-price" oninput="updateQSPreview()" type="number"/>
</div>
</div>
<div class="mb-4 text-center">
<p class="text-sm text-gray-400">মোট বিল হবে:</p>
<p class="text-xl font-bold text-green-400">৳ <span id="qs-total">0</span></p>
<p class="text-xs text-gray-500 mt-1">সম্ভাব্য লাভ: ৳ <span id="qs-profit-preview">0</span></p>
</div>
<div class="flex gap-3">
<button class="flex-1 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700 text-sm" onclick="submitQuickSale()">কনফার্ম</button>
<button class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700 text-sm" onclick="closeModal('modal-quicksale')">বাতিল</button>
</div>
</div>
</div>
<!-- Product Details Modal (Admin View Only) -->
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm" id="modal-product-details">
<div class="glass-panel p-6 rounded-xl w-full max-w-md mx-4 transform transition-all scale-100">
<h3 class="text-2xl font-bold text-white mb-2" id="pd-name">Product Name</h3>
<span class="bg-blue-900 text-blue-300 text-sm px-2 py-1 rounded uppercase font-bold mb-4 inline-block" id="pd-category">CATEGORY</span>
<!-- Content Container -->
<div class="space-y-4" id="pd-content"></div>
<button class="w-full mt-6 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded font-bold text-sm" onclick="closeModal('modal-product-details')">বন্ধ করুন</button>
</div>
</div>
<!-- Hard Reset Modal -->
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm" id="modal-hard-reset">
<div class="glass-panel p-6 rounded-xl w-full max-w-sm mx-4 border-2 border-red-900/50 shadow-2xl">
<div class="text-center mb-6">
<div class="w-16 h-16 bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-800">
<i class="fa-solid fa-trash-can text-3xl text-red-500"></i>
</div>
<h3 class="text-xl font-bold text-white">কি কি ডিলিট করতে চান?</h3>
<p class="text-sm text-gray-400 mt-2">সতর্কতা: নিচের সিলেক্ট করা আইটেমগুলো চিরতরে মুছে যাবে।</p>
</div>
<div class="space-y-3 mb-6 bg-dark-900 p-4 rounded-lg border border-gray-700">
<label class="flex items-center space-x-3 cursor-pointer custom-checkbox">
<input class="hidden" id="reset-history" type="checkbox"/>
<div class="w-5 h-5 border-2 border-gray-600 rounded flex items-center justify-center transition-colors">
<svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"></path></svg>
</div>
<span class="text-gray-300 text-sm">লেনদেনের ইতিহাস (History)</span>
</label>
<label class="flex items-center space-x-3 cursor-pointer custom-checkbox">
<input class="hidden" id="reset-accounts" type="checkbox"/>
<div class="w-5 h-5 border-2 border-gray-600 rounded flex items-center justify-center transition-colors">
<svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"></path></svg>
</div>
<span class="text-gray-300 text-sm">অ্যাকাউন্ট তালিকা (Accounts)</span>
</label>
<label class="flex items-center space-x-3 cursor-pointer custom-checkbox">
<input class="hidden" id="reset-items" type="checkbox"/>
<div class="w-5 h-5 border-2 border-gray-600 rounded flex items-center justify-center transition-colors">
<svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"></path></svg>
</div>
<span class="text-gray-300 text-sm">সার্ভিস ও প্রোডাক্ট তালিকা</span>
</label>
</div>
<div class="flex gap-3">
<button class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded font-bold transition shadow-lg text-sm" onclick="submitHardReset()">মুছে ফেলুন</button>
<button class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded transition text-sm" onclick="closeModal('modal-hard-reset')">বাতিল</button>
</div>
</div>
</div>
<!-- Admin Add/Edit Item Modal -->
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden backdrop-blur-sm overflow-y-auto" id="modal-item">
<div class="glass-panel p-6 rounded-xl w-full max-w-lg mx-4 my-10">
<h3 class="text-xl font-bold text-white mb-4" id="modal-item-title">নতুন কাজ/প্রোডাক্ট যুক্ত করুন</h3>
<input id="item-id" type="hidden"/>
<div class="grid grid-cols-1 gap-3">
<input class="input-field" id="item-name" placeholder="কাজের/প্রোডাক্টের নাম" type="text"/>
<input class="input-field" id="item-category" placeholder="ক্যাটাগরি (উদাঃ পাসপোর্ট, রিচার্জ)" type="text"/>
<textarea class="input-field h-20" id="item-docs" placeholder="প্রয়োজনীয় কাগজপত্র (কমা দিয়ে লিখুন)"></textarea>
<div class="grid grid-cols-2 gap-3">
<div><label class="text-sm text-gray-400">কেনা দাম (Cost)</label><input class="input-field" id="item-cost" placeholder="0" type="number"/></div>
<div><label class="text-sm text-gray-400">বিক্রয় মূল্য (Price)</label><input class="input-field" id="item-price" placeholder="0" type="number"/></div>
</div>
<div><label class="text-sm text-gray-400">স্টক পরিমাণ</label><input class="input-field" id="item-stock" placeholder="Unlimited হলে -1 দিন" type="number"/></div>
</div>
<div class="flex gap-3 mt-6">
<button class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm" onclick="saveItem()">সেভ করুন</button>
<button class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700 text-sm" onclick="closeModal('modal-item')">বাতিল</button>
</div>
</div>
</div>
<!-- CSS Helper Classes for Inputs -->
<style>
        .input-field {
            width: 100%;
            background-color: #1e293b;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: white;
            font-size: 0.875rem;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
        }
    </style>
<!-- JAVASCRIPT LOGIC -->
<script>
        // --- DATA STRUCTURE & STATE ---
        const initialData = {
            cash: 0,
            balance: 0,
            stockVal: 0,
            profit: 0,
            profitDisplayMode: 'all', // 'all', 'daily', 'weekly', 'monthly', 'yearly'
            items: [], 
            history: [],
            accounts: [],
            typeSettings: {}, // NEW: To store rates for each type
            cardOrder: ['capital', 'cash', 'balance', 'stock', 'profit'] 
        };

        let appData = initialData;
        let localDbList = []; 
        let currentDashboardView = 'products'; // Default view
        let currentAccountFilter = 'All'; // Default filter
        
        // --- NEW: Desco Interface State ---
        let currentDescoAccount = null;
        let descoCalculatorState = {
            cashInput: '',
            isDueMode: false,
            dueName: '',
            preview: null
        };

        let masterDB = null;
        let activeDB = null;
        let activeDBUnsubscribe = null;
        
        // --- HARDCODED MASTER CONFIG ---
        const MASTER_CONFIG = {
            apiKey: "AIzaSyC6mBOhj1HGCy0wtbPEI0SLs99NsKOo6kI",
            authDomain: "nokshalab-nokshalab.firebaseapp.com",
            projectId: "nokshalab-nokshalab",
            storageBucket: "nokshalab-nokshalab.firebasestorage.app",
            messagingSenderId: "1023619403590",
            appId: "1:1023619403590:web:971cab0bc3bee397f91f47"
        };

        let isAdminLoggedIn = localStorage.getItem('isAdminLoggedIn') === 'true';
        const savedActiveConfig = localStorage.getItem('activeConfig');

        // Stats Card Definitions
        const statsDefinitions = {
            'capital': { icon: 'fa-coins', color: 'teal', title: 'মোট মূলধন', valueKey: 'capital', sub: 'ক্যাশ + ব্যালেন্স + স্টক', action: '' },
            'cash': { icon: 'fa-wallet', color: 'green', title: 'ক্যাশ টাকা', valueKey: 'cash', sub: 'ক্যাশ ম্যানেজমেন্ট করতে ক্লিক করুন', action: "switchDashboardView('cash')" },
            'balance': { icon: 'fa-building-columns', color: 'blue', title: 'অ্যাকাউন্ট ব্যালেন্স', valueKey: 'balance', sub: 'বিকাশ, রকেট, ইত্যাদির হিসাব', action: "switchDashboardView('accounts')" },
            'stock': { icon: 'fa-boxes-stacked', color: 'orange', title: 'স্টক এমাউন্ট', valueKey: 'stockVal', sub: 'মোট স্টকের কেনা দাম', action: "switchDashboardView('products')" },
            'profit': { icon: 'fa-chart-line', color: 'purple', title: 'মোট লাভ', valueKey: 'profit', sub: 'বিস্তারিত দেখতে ক্লিক করুন', action: "switchDashboardView('profit')" }
        };

        // --- AUTHENTICATION ---
        const ADMIN_PASS = "M~R.88@Mizhan.25";

        function checkAuthOnLoad() {
            if (isAdminLoggedIn) {
                document.getElementById('modal-login').classList.add('hidden');
                document.getElementById('section-admin').classList.remove('hidden-section');
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('settings-btn').classList.remove('hidden'); 
                document.getElementById('history-btn').classList.remove('hidden'); 
                renderAdminPanel();
                startClock(); // Start the clock only when admin is viewing
            } else {
                document.getElementById('modal-login').classList.remove('hidden');
            }
        }

        function performLogin() {
            const pass = document.getElementById('admin-password').value;
            if (pass === ADMIN_PASS) {
                isAdminLoggedIn = true;
                localStorage.setItem('isAdminLoggedIn', 'true');
                document.getElementById('modal-login').classList.add('hidden');
                document.getElementById('section-admin').classList.remove('hidden-section');
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('settings-btn').classList.remove('hidden');
                document.getElementById('history-btn').classList.remove('hidden'); 
                showToast("লগইন সফল হয়েছে!", "success");
                renderAdminPanel();
                startClock(); // Start the clock
            } else {
                showToast("ভুল পাসওয়ার্ড!", "error");
            }
        }

        function logout() {
            isAdminLoggedIn = false;
            localStorage.setItem('isAdminLoggedIn', 'false');
            location.reload(); 
        }

        function openSettingsModal() {
            document.getElementById('modal-settings').classList.remove('hidden');
        }

        function openHistoryModal() {
            document.getElementById('modal-history').classList.remove('hidden');
            renderHistory(); 
        }

        // --- CLOCK FUNCTION (NEW) ---
        function startClock() {
            function update() {
                const now = new Date();
                
                // Bangla Date Options
                const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
                
                const dateStr = now.toLocaleDateString('bn-BD', dateOptions);
                const timeStr = now.toLocaleTimeString('bn-BD', timeOptions).toUpperCase(); // UpperCase for AM/PM if English, usually Bangla handles it

                const dateEl = document.getElementById('live-date');
                const timeEl = document.getElementById('live-time');
                
                if(dateEl && timeEl) {
                    dateEl.innerText = dateStr;
                    timeEl.innerText = timeStr;
                }
            }
            update(); // Initial call
            setInterval(update, 1000); // Update every second
        }

        function switchDashboardView(viewName) {
            currentDashboardView = viewName;
            
            // Hide all views
            document.getElementById('view-products').classList.add('hidden');
            document.getElementById('view-accounts').classList.add('hidden');
            document.getElementById('view-cash').classList.add('hidden');
            document.getElementById('view-profit').classList.add('hidden');

            // Show selected view
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            // Update Card Highlights
            updateActiveCardStyle();

            // Refresh data for the specific view
            if(viewName === 'accounts') renderAccountsList();
            if(viewName === 'products') renderAdminItems(); 
            if(viewName === 'profit') renderProfitView();
            if(viewName === 'cash') document.getElementById('view-cash-display').innerText = '৳ ' + (appData.cash || 0);
        }

        function updateActiveCardStyle() {
            // Reset all cards
            const allCards = document.querySelectorAll('.draggable-item[data-type="card"]');
            allCards.forEach(card => {
                card.classList.remove('card-active-stock', 'card-active-balance', 'card-active-cash', 'card-active-profit', 'border-2');
                card.classList.add('border'); // Reset to default border
            });

            // Find and highlight current view card
            let targetKey = '';
            if (currentDashboardView === 'products') targetKey = 'stock';
            if (currentDashboardView === 'accounts') targetKey = 'balance';
            if (currentDashboardView === 'cash') targetKey = 'cash';
            if (currentDashboardView === 'profit') targetKey = 'profit';

            if(targetKey) {
                const targetCard = document.getElementById(`card-${targetKey}`);
                if(targetCard) {
                    targetCard.classList.remove('border');
                    targetCard.classList.add('border-2', `card-active-${targetKey}`);
                }
            }
        }

        // --- PROFIT VIEW LOGIC ---
        function renderProfitView() {
            // Setup display mode if not exists
            if (!appData.profitDisplayMode) appData.profitDisplayMode = 'all';

            // Calculate Profits based on time
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay()).getTime();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const startOfYear = new Date(now.getFullYear(), 0, 1).getTime();

            const history = appData.history || [];

            // Helper to calc sum
            const calcSum = (filterFn) => history.filter(filterFn).reduce((sum, item) => sum + (item.totalProfit || 0), 0);

            const profits = {
                daily: calcSum(item => item.id >= startOfDay),
                weekly: calcSum(item => item.id >= startOfWeek),
                monthly: calcSum(item => item.id >= startOfMonth),
                yearly: calcSum(item => item.id >= startOfYear),
                all: appData.profit // Total profit stored in variable (legacy/manual compatible)
            };

            // Render Toggle Controls
            const toggleContainer = document.getElementById('profit-toggle-container');
            toggleContainer.innerHTML = '';
            
            const options = [
                { key: 'all', label: 'All Time' },
                { key: 'daily', label: 'দৈনিক (Daily)' },
                { key: 'weekly', label: 'সাপ্তাহিক (Weekly)' },
                { key: 'monthly', label: 'মাসিক (Monthly)' },
                { key: 'yearly', label: 'বাৎসরিক (Yearly)' }
            ];

            options.forEach(opt => {
                const isChecked = appData.profitDisplayMode === opt.key ? 'checked' : '';
                const activeClass = appData.profitDisplayMode === opt.key ? 'bg-purple-600 border-purple-500 text-white' : 'bg-dark-900 border-gray-600 text-gray-400 hover:bg-dark-700';
                
                const btn = `
                    <label class="cursor-pointer ${activeClass} border px-4 py-2 rounded-lg text-sm font-bold transition select-none">
                        <input type="radio" name="profit_mode" value="${opt.key}" class="hidden" ${isChecked} onchange="setProfitDisplayMode('${opt.key}')">
                        ${appData.profitDisplayMode === opt.key ? '<i class="fa-solid fa-check-circle mr-1"></i>' : '<i class="fa-regular fa-circle mr-1"></i>'}
                        ${opt.label}
                    </label>
                `;
                toggleContainer.innerHTML += btn;
            });

            // Render Cards Grid
            const grid = document.getElementById('profit-cards-grid');
            grid.innerHTML = '';

            const cardData = [
                { key: 'daily', title: 'আজকের লাভ', val: profits.daily, icon: 'fa-sun', color: 'orange' },
                { key: 'weekly', title: 'এই সপ্তাহের লাভ', val: profits.weekly, icon: 'fa-calendar-week', color: 'blue' },
                { key: 'monthly', title: 'এই মাসের লাভ', val: profits.monthly, icon: 'fa-calendar-days', color: 'green' },
                { key: 'yearly', title: 'এই বছরের লাভ', val: profits.yearly, icon: 'fa-calendar', color: 'purple' }
            ];

            cardData.forEach(c => {
                const html = `
                    <div class="bg-dark-800 p-5 rounded-lg border border-gray-700 relative group overflow-hidden">
                        <div class="absolute right-0 top-0 p-3 opacity-10">
                            <i class="fa-solid ${c.icon} text-5xl text-${c.color}-500"></i>
                        </div>
                        <h4 class="text-gray-400 text-sm font-medium mb-1">${c.title}</h4>
                        <p class="text-2xl font-bold text-${c.color}-400">৳ ${c.val}</p>
                        <p class="text-[10px] text-gray-500 mt-1">অটোমেটিক হিসাব</p>
                        
                        <div class="mt-3 pt-3 border-t border-gray-700 flex justify-end">
                             <button onclick="resetProfitTimeframe('${c.key}')" class="text-red-400 hover:text-red-300 text-xs flex items-center gap-1 opacity-60 hover:opacity-100 transition">
                                <i class="fa-solid fa-rotate-left"></i> রিসেট
                             </button>
                        </div>
                    </div>
                `;
                grid.innerHTML += html;
            });

            // Update Total Display
            document.getElementById('profit-all-time-display').innerText = '৳ ' + profits.all;
        }

        function setProfitDisplayMode(mode) {
            appData.profitDisplayMode = mode;
            saveData();
            renderProfitView(); // Update toggle UI
            renderAdminPanel(); // Update Main Dashboard Card
        }

        function resetProfitTimeframe(timeframe) {
            if(!confirm(`আপনি কি নিশ্চিত '${timeframe}' এর লাভ রিসেট করতে চান? \n\nবিঃদ্রঃ এটি ওই সময়ের লেনদেনের হিস্টোরি ডিলিট করে দিবে।`)) return;

            const now = new Date();
            let cutoff = 0;

            if (timeframe === 'daily') cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            else if (timeframe === 'weekly') cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay()).getTime();
            else if (timeframe === 'monthly') cutoff = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            else if (timeframe === 'yearly') cutoff = new Date(now.getFullYear(), 0, 1).getTime();

            // Filter history: Keep items older than cutoff OR keep items that didn't generate profit (optional logic, but simple is best)
            // Here we remove items >= cutoff
            appData.history = appData.history.filter(item => item.id < cutoff);
            
            // Recalculate total profit based on remaining history to keep sync, or keep total separate?
            // User wants total control. Let's subtract deleted amount from total profit to be accurate.
            // Actually, simplest is to just delete history. Total profit variable `appData.profit` might need manual adjustment or we recalculate it from scratch.
            // Let's Recalculate Total Profit from scratch for consistency.
            let newTotal = appData.history.reduce((sum, h) => sum + (h.totalProfit || 0), 0);
            
            // Re-calc total profit from remaining history
             appData.profit = newTotal;

            saveData();
            renderProfitView();
            renderAdminPanel();
            showToast("হিস্টোরি ও লাভ রিসেট করা হয়েছে", "success");
        }

        // --- FIREBASE LOGIC ---
        function initMasterApp(config) {
            try {
                let app;
                const existingApp = firebase.apps.find(a => a.name === 'masterApp');
                if (existingApp) {
                    app = existingApp;
                } else {
                    app = firebase.initializeApp(config, 'masterApp');
                }
                
                masterDB = app.firestore();
                document.getElementById('master-indicator').classList.remove('bg-gray-500');
                document.getElementById('master-indicator').classList.add('bg-green-500', 'animate-pulse');
                document.getElementById('master-text').innerText = "Master: Connected";
                document.getElementById('firebase-status').classList.remove('hidden');
                
                fetchTeamConfigs();

            } catch (err) {
                console.error("Master Init Error", err);
                showToast("মাস্টার কানেকশন ফেইল্ড", "error");
            }
        }

        function fetchTeamConfigs() {
            if(!masterDB) return;
            const listDiv = document.getElementById('team-config-list');
            listDiv.innerHTML = '<div class="text-center text-gray-500 py-2"><i class="fa-solid fa-spinner fa-spin"></i> লোড হচ্ছে...</div>';

            masterDB.collection('shared_configs').onSnapshot(snapshot => {
                localDbList = []; 
                if(snapshot.empty) {
                    listDiv.innerHTML = '<div class="text-center text-gray-500 text-xs">কোনো শেয়ার্ড ডাটাবেজ নেই।</div>';
                    return;
                }

                snapshot.forEach(doc => {
                    localDbList.push({ id: doc.id, ...doc.data() });
                });

                const savedOrder = JSON.parse(localStorage.getItem('dbListOrder') || '[]');
                if (savedOrder.length > 0) {
                    localDbList.sort((a, b) => {
                        const idxA = savedOrder.indexOf(a.id);
                        const idxB = savedOrder.indexOf(b.id);
                        if (idxA === -1 && idxB === -1) return 0;
                        if (idxA === -1) return 1;
                        if (idxB === -1) return -1;
                        return idxA - idxB;
                    });
                }

                renderDbList(); 

                if (!activeDB && !localStorage.getItem('activeConfig') && localDbList.length > 0) {
                    const firstConfig = localDbList[0];
                    if (firstConfig && firstConfig.config) {
                        initActiveApp(firstConfig.config);
                        showToast(`অটো-কানেক্ট: ${firstConfig.name}`, "neutral");
                    }
                }

            }, error => {
                console.error("Master DB Access Error:", error);
                listDiv.innerHTML = `<div class="text-center text-red-400 py-2 text-xs">Access Denied!</div>`;
            });
        }

        function renderDbList() {
            const listDiv = document.getElementById('team-config-list');
            listDiv.innerHTML = '';
            
            localDbList.forEach((data, index) => {
                let activeStyle = "border-gray-700 bg-dark-800";
                if (savedActiveConfig && data.config && JSON.parse(savedActiveConfig).projectId === data.config.projectId) {
                    activeStyle = "border-green-500 bg-green-900/20";
                }
                
                const configString = JSON.stringify(data.config).replace(/"/g, '&quot;');
                const cleanConfig = JSON.stringify(data.config).replace(/"/g, '&quot;');
                const safeName = data.name ? data.name.replace(/'/g, "\\'") : '';
                const safeEmail = data.email ? data.email.replace(/'/g, "\\'") : '';

                const item = `
                    <div class="draggable-item border ${activeStyle} rounded p-3 mb-2 flex flex-col md:flex-row justify-between items-start md:items-center gap-3 hover:bg-dark-700"
                          draggable="true" data-type="db" data-index="${index}">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-grip-lines text-gray-600 cursor-grab"></i>
                            <div>
                                <h4 class="font-bold text-white text-sm">${data.name}</h4>
                                <p class="text-xs text-gray-400">${data.email}</p>
                            </div>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="activateDatabase(${configString})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs flex-1 md:flex-none text-center font-medium">
                                ব্যবহার করুন
                            </button>
                            <button onclick="editSharedConfig('${data.id}', '${safeName}', '${safeEmail}', '${cleanConfig}')" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="deleteSharedConfig('${data.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                listDiv.innerHTML += item;
            });
            addDragListeners();
        }

        // --- SHARED CONFIG CRUD ---
        function shareMyConfig() {
            if(!masterDB) { showToast("মাস্টার ডাটাবেজ কানেক্টেড নয়!", "error"); return; }
            const docId = document.getElementById('share-doc-id').value;
            const name = document.getElementById('share-name').value;
            const email = document.getElementById('share-email').value;
            const configStr = document.getElementById('share-config').value;
            if(!name || !email || !configStr) { showToast("সব তথ্য পূরণ করুন", "error"); return; }
            let config;
            try { try { config = JSON.parse(configStr); } catch(e) { config = new Function("return " + configStr)(); } }
            catch(e) { showToast("ভুল কনফিগারেশন কোড", "error"); return; }
            const payload = { name, email, config, timestamp: new Date() };
            const action = docId ? masterDB.collection('shared_configs').doc(docId).update(payload) : masterDB.collection('shared_configs').add(payload);
            action.then(() => { showToast(docId ? "আপডেট সফল হয়েছে!" : "কনফিগারেশন শেয়ার সফল হয়েছে!", "success"); resetShareForm(); })
            .catch(err => { console.error(err); showToast("অ্যাকশন ব্যর্থ হয়েছে (Rules চেক করুন)", "error"); });
        }

        function editSharedConfig(id, name, email, configStr) {
            document.getElementById('share-doc-id').value = id;
            document.getElementById('share-name').value = name;
            document.getElementById('share-email').value = email;
            try { const obj = JSON.parse(configStr); document.getElementById('share-config').value = JSON.stringify(obj, null, 2); } 
            catch(e) { document.getElementById('share-config').value = configStr; }
            document.getElementById('btn-share-config').innerText = "আপডেট করুন";
            document.getElementById('btn-reset-share').classList.remove('hidden');
            document.getElementById('share-name').scrollIntoView({ behavior: 'smooth' });
            
            // If settings modal is not open, open it so user can see what they are editing
            if(document.getElementById('modal-settings').classList.contains('hidden')){
                openSettingsModal();
            }
        }

        function deleteSharedConfig(id) {
            if(!masterDB) return;
            if(confirm("আপনি কি নিশ্চিত এই কনফিগারেশনটি ডিলিট করতে চান?")) {
                masterDB.collection('shared_configs').doc(id).delete().then(() => showToast("কনফিগারেশন ডিলিট হয়েছে", "neutral")).catch(err => showToast("ডিলিট ব্যর্থ হয়েছে", "error"));
            }
        }

        function resetShareForm() {
            document.getElementById('share-doc-id').value = '';
            document.getElementById('share-name').value = '';
            document.getElementById('share-email').value = '';
            document.getElementById('share-config').value = '';
            document.getElementById('btn-share-config').innerText = "শেয়ার করুন";
            document.getElementById('btn-reset-share').classList.add('hidden');
        }

        function activateDatabase(config) {
            localStorage.setItem('activeConfig', JSON.stringify(config));
            initActiveApp(config);
            showToast("ডাটাবেজ এক্টিভেট হয়েছে!", "success");
        }

        function initActiveApp(config) {
            try {
                if (firebase.apps.length > 0) {
                    const defaultApp = firebase.apps.find(a => a.name === '[DEFAULT]');
                    if(defaultApp) { defaultApp.delete().then(() => doInitActive(config)); } else { doInitActive(config); }
                } else { doInitActive(config); }
            } catch(e) { console.error(e); }
        }

        function doInitActive(config) {
            const app = firebase.initializeApp(config);
            activeDB = app.firestore();
            document.getElementById('active-indicator').classList.remove('bg-gray-500');
            document.getElementById('active-indicator').classList.add('bg-green-500', 'animate-pulse');
            document.getElementById('active-text').innerText = "Active: " + config.projectId;
            document.getElementById('firebase-status').classList.remove('hidden');
            const docRef = activeDB.collection('noksha_store').doc('main_data');
            activeDBUnsubscribe = docRef.onSnapshot((doc) => {
                if (doc.exists) {
                    appData = doc.data();
                    if(!appData.accounts) appData.accounts = [];
                    if(!appData.items) appData.items = [];
                    // Ensure cardOrder is robustly initialized
                    if(!appData.cardOrder || !Array.isArray(appData.cardOrder)) {
                        appData.cardOrder = initialData.cardOrder;
                    } else if (!appData.cardOrder.includes('capital')) {
                        appData.cardOrder.unshift('capital');
                    }
                    if(!appData.profitDisplayMode) appData.profitDisplayMode = 'all'; // Default
                    if(!appData.typeSettings) appData.typeSettings = {}; // NEW: Ensure typeSettings exists
                    refreshUI();
                } else { appData = initialData; refreshUI(); }
            });
        }

        function saveData() {
            localStorage.setItem('nokshaData', JSON.stringify(appData));
            if (activeDB) { activeDB.collection('noksha_store').doc('main_data').set(appData).catch(err => console.error("Save Error", err)); }
            refreshUI();
        }

        function confirmResetProfit() {
            if(confirm("সতর্কতা: আপনি কি 'মোট লাভ' (All Time) এর হিসাব ০ (শূন্য) করতে চান? এটি সমস্ত হিস্টোরি মুছে ফেলবে।")) {
                appData.profit = 0;
                appData.history = []; // Resetting total profit effectively means resetting history in this system
                saveData();
                renderAdminPanel();
                renderProfitView();
                showToast("সম্পূর্ণ লাভ ও হিস্টোরি রিসেট করা হয়েছে", "success");
            }
        }

        function resetCash() {
            if(confirm("সতর্কতা: আপনি কি নিশ্চিত ক্যাশ ব্যালেন্স ০ (শূন্য) করতে চান?")) {
                appData.cash = 0;
                addToHistory('ক্যাশ রিসেট', 'ম্যানুয়াল রিসেট', 0, 0, 0, 0);
                saveData();
                renderAdminPanel();
                // We don't have a modal anymore, just refresh UI
                refreshUI(); 
                showToast("ক্যাশ রিসেট করা হয়েছে", "success");
            }
        }

        function openHardResetModal() {
            document.getElementById('modal-hard-reset').classList.remove('hidden');
        }

        function submitHardReset() {
            if(!activeDB) { showToast("ডাটাবেজ কানেক্টেড নয়!", "error"); return; }
            
            const wipeHistory = document.getElementById('reset-history').checked;
            const wipeAccounts = document.getElementById('reset-accounts').checked;
            const wipeItems = document.getElementById('reset-items').checked;

            if(!wipeHistory && !wipeAccounts && !wipeItems) {
                showToast("কমপক্ষে একটি অপশন সিলেক্ট করুন", "error");
                return;
            }

            if(confirm("আপনি কি নিশ্চিত নির্বাচিত ডাটাগুলো ডিলিট করতে চান?")) {
                if (wipeHistory) { appData.history = []; appData.profit = 0; } // Profit linked to history
                if (wipeAccounts) appData.accounts = [];
                if (wipeItems) appData.items = [];

                saveData();
                closeModal('modal-hard-reset');
                showToast("নির্বাচিত ডাটা ডিলিট করা হয়েছে", "success");
                refreshUI();
            }
        }

        // --- UI REFRESH ---
        function refreshUI() {
            if(isAdminLoggedIn) {
                renderAdminPanel();
                
                // Refresh views if they are active
                if(!document.getElementById('view-accounts').classList.contains('hidden')) renderAccountsList();
                if(!document.getElementById('view-products').classList.contains('hidden')) renderAdminItems();
                if(!document.getElementById('view-profit').classList.contains('hidden')) renderProfitView();
                if(!document.getElementById('view-cash').classList.contains('hidden')) {
                     document.getElementById('view-cash-display').innerText = '৳ ' + (appData.cash || 0);
                }

                // Also refresh history if the modal is open, to keep it live
                if(!document.getElementById('modal-history').classList.contains('hidden')) renderHistory();
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderAdminPanel() {
            let totalAccountBalance = appData.accounts.reduce((acc, curr) => acc + parseInt(curr.balance), 0);
            appData.balance = totalAccountBalance;
            let totalStockVal = appData.items.reduce((acc, item) => { if(item.stock > 0) return acc + (item.cost * item.stock); return acc; }, 0);
            appData.stockVal = totalStockVal;
            
            // Calc Capital
            appData.capital = appData.cash + totalAccountBalance + totalStockVal;

            const statsContainer = document.getElementById('admin-stats-container');
            statsContainer.innerHTML = '';
            
            if(!appData.cardOrder || !Array.isArray(appData.cardOrder)) {
                appData.cardOrder = ['capital', 'cash', 'balance', 'stock', 'profit'];
            } else if(!appData.cardOrder.includes('capital')) {
                appData.cardOrder.unshift('capital');
            }

            appData.cardOrder.forEach((key, index) => {
                const def = statsDefinitions[key];
                if(!def) return;
                
                // Logic for Profit Card Display Value
                let displayVal = appData[def.valueKey];
                let displaySub = def.sub;

                if (key === 'profit') {
                    // Recalculate based on mode
                    if (appData.profitDisplayMode && appData.profitDisplayMode !== 'all') {
                        const now = new Date();
                        const history = appData.history || [];
                        let cutoff = 0;
                        if (appData.profitDisplayMode === 'daily') cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                        else if (appData.profitDisplayMode === 'weekly') cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay()).getTime();
                        else if (appData.profitDisplayMode === 'monthly') cutoff = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                        else if (appData.profitDisplayMode === 'yearly') cutoff = new Date(now.getFullYear(), 0, 1).getTime();

                        displayVal = history.filter(item => item.id >= cutoff).reduce((sum, item) => sum + (item.totalProfit || 0), 0);
                        
                        // Custom Subtext
                        const labels = { daily: 'আজকের লাভ', weekly: 'এই সপ্তাহের লাভ', monthly: 'এই মাসের লাভ', yearly: 'এই বছরের লাভ' };
                        displaySub = labels[appData.profitDisplayMode] + ' (অটো)';
                    }
                }

                let cardClasses = "draggable-item bg-dark-800 p-5 rounded-xl border border-gray-700 shadow-lg relative overflow-hidden group transition";
                let onClickAttr = "";
                if (def.action) { cardClasses += ` cursor-pointer hover:border-${def.color}-500`; onClickAttr = `onclick="${def.action}"`; }
                
                // Add ID for highlighting
                const cardId = `card-${key}`;

                const card = `
                    <div id="${cardId}" ${onClickAttr} class="${cardClasses}" draggable="true" data-type="card" data-index="${index}">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition">
                            <i class="fa-solid ${def.icon} text-6xl text-${def.color}-500"></i>
                        </div>
                        <h4 class="text-gray-400 text-sm font-medium uppercase flex items-center gap-2">
                            <i class="fa-solid fa-grip-vertical text-gray-600 cursor-grab mr-1"></i> ${def.title}
                            ${def.action ? `<i class="fa-solid fa-pen-to-square text-gray-500 text-xs hover:text-white ml-auto"></i>` : ''}
                        </h4>
                        <p class="text-2xl font-bold text-${def.color}-400 mt-1">৳ ${displayVal}</p>
                        ${displaySub ? `<p class="text-xs text-gray-500 mt-1">${displaySub}</p>` : ''}
                    </div>
                `;
                statsContainer.innerHTML += card;
            });

            // Apply highlight immediately after rendering cards
            updateActiveCardStyle();

            renderAdminItems();
            renderHistory();
            addDragListeners();
        }

        function renderAdminItems() {
            const tbody = document.getElementById('admin-items-body');
            const searchVal = document.getElementById('admin-search').value.toLowerCase();
            tbody.innerHTML = '';
            
            if (appData.items.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="7" class="p-5 text-center text-gray-500">কোনো আইটেম নেই।</td></tr>`;
                 return;
            }

            const isDraggable = searchVal === '';

            appData.items.forEach((item, index) => {
                if (item.name.toLowerCase().includes(searchVal) || item.category.toLowerCase().includes(searchVal)) {
                    const draggableAttr = isDraggable ? 'draggable="true"' : '';
                    const rowClass = isDraggable ? 'draggable-item' : '';
                    
                    const row = `
                        <tr class="border-b border-gray-700 hover:bg-dark-700 transition ${rowClass}" ${draggableAttr} data-type="item" data-index="${index}">
                            <td class="p-4 text-white font-medium flex items-center gap-2">
                                ${isDraggable ? '<i class="fa-solid fa-grip-lines text-gray-600 mr-2 cursor-grab"></i>' : ''}
                                <span class="hover:text-blue-400 cursor-pointer hover:underline" onclick="openProductDetails(${item.id})">${item.name}</span>
                            </td>
                            <td class="p-4"><span class="bg-gray-700 text-xs px-2 py-1 rounded">${item.category}</span></td>
                            <td class="p-4 text-red-300">${item.cost}</td>
                            <td class="p-4 text-green-300">${item.price}</td>
                            <td class="p-4">${item.stock === -1 ? '∞' : item.stock}</td>
                            <td class="p-4 text-center">
                                <button onclick="openQuickSaleModal(${item.id})" class="bg-green-600 hover:bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center mx-auto shadow-md transform hover:scale-110 transition"><i class="fa-solid fa-check"></i></button>
                            </td>
                            <td class="p-4 text-right">
                                <button onclick="openItemModal(${item.id})" class="text-blue-400 hover:text-blue-300 mr-2"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteItem(${item.id})" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>`;
                    tbody.innerHTML += row;
                }
            });
            if (isDraggable) addDragListeners();
        }

        // --- GLOBAL DRAG AND DROP LOGIC ---
        let dragSrcEl = null; let dragType = null; let dragStartIndex = null;
        function addDragListeners() {
            const items = document.querySelectorAll('.draggable-item');
            items.forEach(item => {
                item.removeEventListener('dragstart', handleDragStart); item.removeEventListener('dragover', handleDragOver); item.removeEventListener('drop', handleDrop); item.removeEventListener('dragenter', handleDragEnter); item.removeEventListener('dragleave', handleDragLeave);
                item.addEventListener('dragstart', handleDragStart); item.addEventListener('dragover', handleDragOver); item.addEventListener('drop', handleDrop); item.addEventListener('dragenter', handleDragEnter); item.addEventListener('dragleave', handleDragLeave);
            });
        }
        function handleDragStart(e) { dragSrcEl = this; dragType = this.getAttribute('data-type'); dragStartIndex = +this.getAttribute('data-index'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.innerHTML); this.classList.add('dragging'); }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); return false; }
        function handleDragEnter(e) { this.classList.add('bg-dark-600'); }
        function handleDragLeave(e) { this.classList.remove('bg-dark-600'); }
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation(); this.classList.remove('dragging'); this.classList.remove('bg-dark-600');
            const targetType = this.getAttribute('data-type'); const targetIndex = +this.getAttribute('data-index');
            if (dragSrcEl !== this && dragType === targetType) {
                if (dragType === 'item') { const movedItem = appData.items.splice(dragStartIndex, 1)[0]; appData.items.splice(targetIndex, 0, movedItem); saveData(); renderAdminItems(); } 
                else if (dragType === 'card') { const movedCard = appData.cardOrder.splice(dragStartIndex, 1)[0]; appData.cardOrder.splice(targetIndex, 0, movedCard); saveData(); renderAdminPanel(); }
                else if (dragType === 'account') { const movedAcc = appData.accounts.splice(dragStartIndex, 1)[0]; appData.accounts.splice(targetIndex, 0, movedAcc); saveData(); renderAccountsList(); }
                else if (dragType === 'db') { const movedDb = localDbList.splice(dragStartIndex, 1)[0]; localDbList.splice(targetIndex, 0, movedDb); const orderIds = localDbList.map(db => db.id); localStorage.setItem('dbListOrder', JSON.stringify(orderIds)); renderDbList(); showToast("ডাটাবেজ সাজানো হয়েছে", "success"); }
            } return false;
        }

        // --- NEW FEATURES LOGIC ---

        function openProductDetails(id) {
            const item = appData.items.find(i => i.id === id);
            if(!item) return;

            document.getElementById('pd-name').innerText = item.name;
            document.getElementById('pd-category').innerText = item.category;
            const contentDiv = document.getElementById('pd-content');
            contentDiv.innerHTML = '';

            const totalStockCost = item.stock * item.cost;
            const totalStockSale = item.stock * item.price;
            const totalStockProfit = item.stock * (item.price - item.cost);
            
            contentDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-dark-800 p-3 rounded">
                        <p class="text-gray-400">বর্তমান স্টক</p>
                        <p class="text-xl font-bold text-white">${item.stock === -1 ? '∞' : item.stock + ' টি'}</p>
                    </div>
                    <div class="bg-dark-800 p-3 rounded">
                        <p class="text-gray-400">প্রতি পিস লাভ</p>
                        <p class="text-xl font-bold text-green-400">৳ ${item.price - item.cost}</p>
                    </div>
                </div>
                <div class="bg-dark-900 p-4 rounded border border-gray-700">
                    <h4 class="text-gray-300 font-bold mb-3 border-b border-gray-700 pb-2">স্টক বিশ্লেষণ</h4>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-400">মোট কেনা খরচ:</span>
                        <span class="text-red-400 font-bold">৳ ${totalStockCost}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-400">সম্ভাব্য বিক্রয় মূল্য:</span>
                        <span class="text-blue-400 font-bold">৳ ${totalStockSale}</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-gray-700">
                        <span class="text-gray-300">সম্ভাব্য মোট লাভ:</span>
                        <span class="text-green-400 font-bold text-lg">৳ ${totalStockProfit}</span>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-500 mb-1">প্রয়োজনীয় কাগজপত্র:</p>
                    <p class="text-gray-300 text-sm bg-dark-800 p-2 rounded">${item.docs}</p>
                </div>
            `;

            document.getElementById('modal-product-details').classList.remove('hidden');
        }

        let currentQuickSaleItem = null;
        function openQuickSaleModal(id) {
            currentQuickSaleItem = appData.items.find(i => i.id === id);
            document.getElementById('qs-name').innerText = currentQuickSaleItem.name;
            document.getElementById('qs-price').innerText = currentQuickSaleItem.price;
            document.getElementById('qs-cost').innerText = currentQuickSaleItem.cost;
            
            document.getElementById('qs-qty').value = 1;
            document.getElementById('qs-custom-price').value = currentQuickSaleItem.price; 
            
            updateQSPreview();
            document.getElementById('modal-quicksale').classList.remove('hidden');
        }

        function updateQSPreview() {
            if(!currentQuickSaleItem) return;
            const qty = parseInt(document.getElementById('qs-qty').value) || 0;
            const customPrice = parseInt(document.getElementById('qs-custom-price').value) || 0;
            
            const totalBill = qty * customPrice;
            const totalCost = qty * currentQuickSaleItem.cost;
            const potentialProfit = totalBill - totalCost;

            document.getElementById('qs-total').innerText = totalBill;
            
            const profitEl = document.getElementById('qs-profit-preview');
            profitEl.innerText = potentialProfit;
            profitEl.className = potentialProfit >= 0 ? "text-green-400" : "text-red-400";
        }

        function submitQuickSale() {
            const qty = parseInt(document.getElementById('qs-qty').value) || 1;
            const customPrice = parseInt(document.getElementById('qs-custom-price').value) || 0;
            
            if (qty < 1) return;
            const item = currentQuickSaleItem;
            
            const totalCost = parseInt(item.cost) * qty;
            const totalPrice = customPrice * qty; 
            const totalProfit = totalPrice - totalCost;
            
            appData.cash += totalPrice;
            appData.profit += totalProfit;
            if (item.stock > 0) item.stock = Math.max(0, item.stock - qty);

            let note = item.name;
            if(customPrice !== item.price) note += ` (Sold @ ${customPrice})`;

            addToHistory('বিক্রয়', note, qty, totalCost, totalPrice, totalProfit);
            saveData();
            closeModal('modal-quicksale');
            showToast("বিক্রয় সফল", "success");
        }

        // --- EXISTING HELPER FUNCTIONS ---
        function addToHistory(type, name, qty, cost, price, profit) { appData.history.unshift({ id: Date.now(), type, name, qty, totalCost: cost, totalPrice: price, totalProfit: profit, dateStr: new Date().toLocaleDateString('bn-BD'), timeStr: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true }) }); if (appData.history.length > 200) appData.history.pop(); }
        function renderHistory() { const tbody = document.getElementById('history-body'); tbody.innerHTML = ''; if (appData.history.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-500 text-sm">কোনো হিস্ট্রি নেই।</td></tr>'; return; } appData.history.forEach(h => { let typeClass = h.type.includes('বিক্রয়') ? 'text-blue-400' : (h.type.includes('জমা') ? 'text-green-400' : 'text-purple-400'); if(h.type.includes('উত্তোলন') || h.type.includes('খরচ')) typeClass = 'text-red-400'; const row = `<tr class="border-b border-gray-800 hover:bg-dark-800 transition"><td class="p-4 text-gray-400 text-sm font-bold">${h.dateStr}<br><span class="opacity-70 font-normal text-xs">${h.timeStr}</span></td><td class="p-4"><div class="font-medium text-white text-sm">${h.name}</div><div class="text-xs ${typeClass}">${h.type}</div></td><td class="p-4 text-center"><span class="bg-dark-700 text-gray-300 px-2 py-1 rounded text-xs font-bold">${h.qty || 1}</span></td><td class="p-4 text-right text-gray-400 text-sm">৳ ${h.totalCost || 0}</td><td class="p-4 text-right text-white font-bold text-sm">৳ ${h.totalPrice || 0}</td><td class="p-4 text-right text-green-400 font-bold text-sm">+ ৳ ${h.totalProfit || 0}</td><td class="p-4 text-right"><button onclick="deleteHistoryItem(${h.id})" class="text-gray-500 hover:text-red-500 transition text-lg"><i class="fa-solid fa-trash-can"></i></button></td></tr>`; tbody.innerHTML += row; }); }
        
        function deleteHistoryItem(id) {
            if(confirm("আপনি কি নিশ্চিত এই হিস্টোরিটি ডিলিট করতে চান?")) {
                appData.history = appData.history.filter(h => h.id !== id);
                // We should re-calc total profit here ideally, but for legacy compatibility we usually don't unless a full re-calc is requested.
                // However, since we now have "Automatic Profit" view, deleting history WILL update those views automatically on refresh.
                saveData();
                renderHistory();
                showToast("হিস্টোরি ডিলিট করা হয়েছে", "neutral");
            }
        }

        function resetHistory() { if(confirm("সব হিস্ট্রি মুছবেন?")) { appData.history = []; appData.profit = 0; saveData(); } }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showToast(msg, type) { const t = document.getElementById('toast'); t.innerText = msg; t.className = `fixed top-20 right-5 z-50 p-4 rounded-lg shadow-xl text-white ${type==='success'?'bg-green-600':(type==='error'?'bg-red-600':'bg-gray-600')}`; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
        function openAccountsModal() { renderAccountsList(); document.getElementById('modal-manage-accounts').classList.remove('hidden'); }
        
        // UPDATED: Render Accounts with Navigation Filter AND Settings Icon
        function renderAccountsList() { 
            const tbody = document.getElementById('accounts-list-body'); 
            const searchVal = document.getElementById('account-search') ? document.getElementById('account-search').value.toLowerCase() : '';
            const navContainer = document.getElementById('account-nav-container');
            
            // --- Navigation Bar Logic ---
            if(navContainer) {
                navContainer.innerHTML = '';
                const types = ['All', 'Desco', 'Bkash', 'Nagad', 'Rocket', 'Upay', 'GP', 'BL', 'Robi', 'Airtel'];
                
                types.forEach(type => {
                    const isActive = currentAccountFilter === type;
                    const activeClass = isActive ? 'bg-blue-600 text-white border-blue-500' : 'bg-dark-800 text-gray-400 border-gray-700 hover:bg-dark-700 hover:text-white';
                    
                    const btn = document.createElement('button');
                    btn.className = `px-3 py-1 rounded-full text-xs font-bold border transition whitespace-nowrap flex items-center gap-2 ${activeClass}`;
                    
                    // Button Text
                    const textSpan = document.createElement('span');
                    textSpan.innerText = type === 'All' ? 'সব দেখুন' : type;
                    btn.appendChild(textSpan);

                    // Gear Icon (Only for specific types, not 'All')
                    if (type !== 'All') {
                        const gear = document.createElement('i');
                        gear.className = "fa-solid fa-gear text-[10px] opacity-60 hover:opacity-100 hover:text-white transition cursor-pointer p-1 rounded hover:bg-white/20";
                        gear.title = `${type} সেটিংস`;
                        gear.onclick = (e) => {
                            e.stopPropagation(); // Prevent activating the filter when clicking gear
                            openTypeSettings(type);
                        };
                        btn.appendChild(gear);
                    }

                    btn.onclick = () => { currentAccountFilter = type; renderAccountsList(); };
                    navContainer.appendChild(btn);
                });
            }

            tbody.innerHTML = ''; 
            
            let total = 0; 
            
            // Filter accounts
            const filteredAccounts = appData.accounts.filter(acc => {
                const matchesSearch = acc.name.toLowerCase().includes(searchVal);
                const matchesType = currentAccountFilter === 'All' || (acc.type || 'Desco') === currentAccountFilter;
                return matchesSearch && matchesType;
            });

            if(filteredAccounts.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="5" class="p-5 text-center text-gray-500">কোনো অ্যাকাউন্ট নেই। নতুন যুক্ত করুন।</td></tr>'; 
            } 
            
            const isDraggable = searchVal === '' && currentAccountFilter === 'All'; 

            filteredAccounts.forEach((acc, index) => { 
                total += parseInt(acc.balance); 
                
                const realIndex = appData.accounts.indexOf(acc);
                const draggableAttr = isDraggable ? 'draggable="true"' : '';
                const rowClass = isDraggable ? 'draggable-item' : '';

                // Badge logic
                let badgeClass = 'badge-default';
                let typeLabel = acc.type || 'N/A';
                if(acc.type === 'Bkash') badgeClass = 'badge-bkash';
                else if(acc.type === 'Nagad') badgeClass = 'badge-nagad';
                else if(acc.type === 'Rocket') badgeClass = 'badge-rocket';
                else if(acc.type === 'Upay') badgeClass = 'badge-upay';
                else if(acc.type === 'Desco') badgeClass = 'badge-desco';
                else if(acc.type === 'GP') badgeClass = 'badge-gp';
                else if(acc.type === 'BL') badgeClass = 'badge-bl';
                else if(acc.type === 'Robi') badgeClass = 'badge-robi';
                else if(acc.type === 'Airtel') badgeClass = 'badge-airtel';

                // --- NEW: Custom Click Action for Desco ---
                let clickAction = `onclick="openAccountTransactModal(${acc.id})"`;
                if (acc.type === 'Desco') {
                    clickAction = `onclick="openDescoInterface(${acc.id})"`;
                }

                tbody.innerHTML += `
                <tr class="${rowClass} border-b border-gray-700 hover:bg-dark-800 transition" ${draggableAttr} data-type="account" data-index="${realIndex}">
                    <td class="p-4 text-white font-medium flex items-center gap-2">
                        ${isDraggable ? '<i class="fa-solid fa-grip-lines text-gray-600 cursor-grab mr-2"></i>' : ''} 
                        ${acc.name}
                    </td>
                        <td class="p-4 text-center">
                        <span class="text-xs px-2 py-1 rounded font-bold ${badgeClass}">${typeLabel}</span>
                    </td>
                    <td class="p-4 text-right text-blue-400 font-bold">৳ ${acc.balance}</td>
                    <td class="p-4 text-center">
                        <button ${clickAction} class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs"><i class="fa-solid fa-money-bill-transfer"></i></button>
                    </td>
                    <td class="p-4 text-right">
                        <button onclick="editAccount(${acc.id})" class="text-blue-400 hover:text-white mr-2 text-xs"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteAccount(${acc.id})" class="text-red-400 hover:text-white text-xs"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`; 
            }); 
            
            document.getElementById('view-total-balance').innerText = '৳ ' + total; 
            
            // Hide Desco panel if filter is NOT Desco or All, or simply reset it when re-rendering to be safe
            // Actually better to keep it hidden unless explicitly opened
            if (currentDescoAccount && !filteredAccounts.find(a => a.id === currentDescoAccount.id)) {
                closeDescoInterface();
            }

            if(isDraggable) addDragListeners(); 
        }

        // --- NEW: Desco Smart Interface Logic ---
        function openDescoInterface(accId) {
            const acc = appData.accounts.find(a => a.id === accId);
            if (!acc) return;
            currentDescoAccount = acc;
            
            // Reset State
            descoCalculatorState = { cashInput: '', isDueMode: false, dueName: '', preview: null };
            renderDescoInterface();
            
            document.getElementById('desco-transaction-panel').classList.remove('hidden');
            // Scroll to it
            document.getElementById('desco-transaction-panel').scrollIntoView({behavior: 'smooth'});
        }

        function closeDescoInterface() {
            document.getElementById('desco-transaction-panel').classList.add('hidden');
            currentDescoAccount = null;
        }

        function updateDescoInput(val) {
            descoCalculatorState.cashInput = val;
            descoCalculatorState.preview = calculateDescoDetails(val);
            renderDescoInterface();
        }

        function setDescoDueMode(isDue) {
            descoCalculatorState.isDueMode = isDue;
            renderDescoInterface();
        }

        function setDescoDueName(name) {
            descoCalculatorState.dueName = name;
            // No re-render needed for just text input usually, but let's keep it simple
        }

        function calculateDescoDetails(amountStr) {
            const totalCash = parseFloat(amountStr);
            if (!totalCash || isNaN(totalCash)) return null;

            // Get Settings
            const settings = appData.typeSettings['Desco'] || { customerFee: 10, companyCost: 2.5, minRecharge: 100 };
            const custFee = settings.customerFee || 10;
            const compCostRate = settings.companyCost || 2.5;
            const minRecharge = settings.minRecharge || 100;

            let bestRecharge = 0;
            let bestFee = 0;

            // Logic: Maximize recharge within slabs
            // Slab 1: 0-1000 (Fee 10)
            // Slab 2: 1001-2000 (Fee 20)
            // etc.
            const maxSlabsToCheck = Math.ceil(totalCash / 1000) + 2; 

            for (let k = 1; k <= maxSlabsToCheck; k++) {
                const fee = k * custFee;
                const potentialRecharge = totalCash - fee;
                
                if (potentialRecharge <= 0) continue;

                const slabMaxRecharge = k * 1000;
                const slabMinRecharge = (k - 1) * 1000;

                const effectiveRecharge = Math.min(potentialRecharge, slabMaxRecharge);

                if (effectiveRecharge > slabMinRecharge) {
                    if (effectiveRecharge > bestRecharge) {
                        bestRecharge = effectiveRecharge;
                        bestFee = fee;
                    }
                }
            }

            const change = totalCash - (bestRecharge + bestFee);
            const companyCost = (bestRecharge / 1000) * compCostRate;
            const netProfit = bestFee - companyCost;
            const isValid = bestRecharge >= minRecharge;

            return {
                cash: totalCash,
                recharge: bestRecharge,
                deduction: bestFee,
                change: change,
                cost: companyCost,
                profit: netProfit,
                isValid: isValid,
                totalDeductionFromBalance: bestRecharge + companyCost
            };
        }

        function submitDescoSale() {
            const state = descoCalculatorState;
            const details = state.preview;
            const acc = currentDescoAccount;

            if (!details || !acc) return;
            if (!details.isValid) {
                showToast("সর্বনিম্ন রিচার্জ লিমিট কম!", "error");
                return;
            }
            if (acc.balance < details.totalDeductionFromBalance) {
                showToast("একাউন্টে পর্যাপ্ত ব্যালেন্স নেই!", "error");
                return;
            }
            if (state.isDueMode && !state.dueName) {
                showToast("কাস্টমারের নাম লিখুন!", "error");
                return;
            }

            // Execute Transaction
            // 1. Update Desco Account Balance
            acc.balance -= details.totalDeductionFromBalance;
            
            // 2. Update Global Cash (Add Cash collected)
            // Note: If due, cash is not added.
            if (!state.isDueMode) {
                appData.cash += details.cash - details.change; // We keep (Recharge + Fee)
            }

            // 3. Update Profit
            appData.profit += details.profit;

            // 4. History
            const note = `${acc.name} - ${state.isDueMode ? 'বাকি ('+state.dueName+')' : 'নগদ'}`;
            const historyItem = {
                id: Date.now(),
                type: 'Desco Sale',
                name: note,
                qty: 1,
                totalCost: details.totalDeductionFromBalance, // Cost to us
                totalPrice: details.cash - details.change, // Price sold at (Cash collected)
                totalProfit: details.profit,
                dateStr: new Date().toLocaleDateString('bn-BD'),
                timeStr: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            };
            appData.history.unshift(historyItem);
            if (appData.history.length > 200) appData.history.pop();

            saveData();
            showToast("লেনদেন সফল!", "success");
            closeDescoInterface();
            renderAccountsList(); // Refresh list to show new balance
            renderAdminPanel(); // Refresh top cards
        }

        // --- NEW: Desco Balance Load & Correction Functions ---
        function openDescoLoadModal() {
            if(!currentDescoAccount) return;
            document.getElementById('modal-desco-load').classList.remove('hidden');
            document.getElementById('desco-load-amount').value = '';
        }

        function submitDescoLoad() {
            const amount = parseFloat(document.getElementById('desco-load-amount').value);
            if(!amount || amount <= 0) return;
            
            if(appData.cash < amount) {
                showToast("ক্যাশে পর্যাপ্ত টাকা নেই!", "error");
                return;
            }

            // Logic: Decrease Global Cash, Increase Desco Balance
            appData.cash -= amount;
            currentDescoAccount.balance += amount;

            // History
            appData.history.unshift({
                id: Date.now(),
                type: 'Desco Load',
                name: `${currentDescoAccount.name} - লোড`,
                qty: 1,
                totalCost: amount, 
                totalPrice: 0, 
                totalProfit: 0,
                dateStr: new Date().toLocaleDateString('bn-BD'),
                timeStr: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            });

            saveData();
            closeModal('modal-desco-load');
            renderDescoInterface(); // Refresh internal UI
            renderAdminPanel(); // Refresh top cards
            showToast("ব্যালেন্স লোড সফল!", "success");
        }

        function openDescoCorrectionModal() {
            if(!currentDescoAccount) return;
            document.getElementById('modal-desco-correct').classList.remove('hidden');
            document.getElementById('desco-correct-amount').value = currentDescoAccount.balance;
        }

        function submitDescoCorrection() {
            const newBal = parseFloat(document.getElementById('desco-correct-amount').value);
            if(isNaN(newBal)) return;

            const diff = newBal - currentDescoAccount.balance;
            if(diff === 0) { closeModal('modal-desco-correct'); return; }

            currentDescoAccount.balance = newBal;
            
            // History? Maybe just a note
            appData.history.unshift({
                id: Date.now(),
                type: 'Desco Correction',
                name: `${currentDescoAccount.name} - সংশোধন`,
                qty: 1,
                totalCost: 0, 
                totalPrice: 0, 
                totalProfit: 0, // No profit impact usually assumed for correction unless specified
                dateStr: new Date().toLocaleDateString('bn-BD'),
                timeStr: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })
            });

            saveData();
            closeModal('modal-desco-correct');
            renderDescoInterface();
            renderAdminPanel();
            showToast("ব্যালেন্স আপডেট হয়েছে!", "success");
        }

        function renderDescoInterface() {
            const container = document.getElementById('desco-transaction-panel');
            if(!currentDescoAccount) return;
            
            const state = descoCalculatorState;
            const preview = state.preview;
            const quickButtons = [500, 1000, 1010, 1200, 1500, 2000, 2200, 3000, 5000];

            let html = `
                <div class="bg-gray-100 p-4 relative">
                    <button onclick="closeDescoInterface()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
                    
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center text-white text-lg"><i class="fa-solid fa-bolt"></i></div>
                            <div>
                                <h4 class="font-bold text-gray-700 text-lg">${currentDescoAccount.name}</h4>
                                <p class="text-sm text-gray-500 font-bold">বর্তমান ব্যালেন্স: <span class="text-blue-600">৳ ${currentDescoAccount.balance.toFixed(2)}</span></p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="openDescoCorrectionModal()" class="bg-blue-100 text-blue-600 px-3 py-1 rounded text-xs font-bold hover:bg-blue-200 transition"><i class="fa-solid fa-pen"></i> সংশোধন</button>
                             <button onclick="openDescoLoadModal()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-700 transition shadow"><i class="fa-solid fa-plus"></i> ব্যালেন্স লোড</button>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 mb-4">
                        <label class="text-xs font-bold text-gray-500 mb-2 block uppercase">কাস্টমার কত টাকা দিয়েছে?</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-gray-400 font-bold text-xl">৳</span>
                            <input type="number" value="${state.cashInput}" oninput="updateDescoInput(this.value)" placeholder="0" class="w-full pl-10 p-3 text-2xl font-bold rounded-lg border-2 border-blue-200 focus:border-blue-600 focus:outline-none text-gray-800">
                        </div>
                        
                        <div class="flex gap-2 mt-3">
                            <button onclick="setDescoDueMode(false)" class="flex-1 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-1 transition-all ${!state.isDueMode ? 'bg-green-100 text-green-700 ring-1 ring-green-500' : 'bg-gray-100 text-gray-400'}">
                                <i class="fa-solid fa-circle-check"></i> নগদ
                            </button>
                            <!-- Due Mode Disabled as per instruction
                            <button onclick="setDescoDueMode(true)" class="flex-1 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-1 transition-all ${state.isDueMode ? 'bg-red-100 text-red-700 ring-1 ring-red-500' : 'bg-gray-100 text-gray-400'}">
                                <i class="fa-solid fa-triangle-exclamation"></i> বাকি
                            </button> 
                            -->
                        </div>
                        ${state.isDueMode ? `<input type="text" oninput="descoCalculatorState.dueName = this.value" placeholder="কাস্টমারের নাম..." class="w-full mt-2 p-2 border border-red-300 rounded focus:outline-red-500 text-sm">` : ''}
                    </div>
            `;

            // Preview Section
            if (preview) {
                const validClass = preview.isValid ? 'bg-indigo-50 border-indigo-200' : 'bg-red-50 border-red-200';
                html += `<div class="p-4 rounded-xl border ${validClass} mb-4 animate-fade-in">`;
                
                if (!preview.isValid) {
                    html += `
                        <div class="text-center text-red-600">
                            <i class="fa-solid fa-triangle-exclamation text-2xl mb-1"></i>
                            <p class="font-bold text-sm">রিচার্জ পরিমাণ কম!</p>
                            <p class="text-xs">সর্বনিম্ন রিচার্জ ১০০ টাকা হতে হবে।</p>
                        </div>
                    `;
                } else {
                    html += `
                        <h3 class="text-center text-[10px] font-bold text-indigo-800 mb-2 uppercase tracking-wider">লেনদেনের বিস্তারিত</h3>
                        <div class="bg-white p-3 rounded-lg text-center shadow-sm border border-indigo-100 mb-3">
                            <p class="text-[10px] text-gray-500 font-bold uppercase">মেশিনে রিচার্জ করবেন</p>
                            <p class="text-3xl font-black text-indigo-600">৳ ${preview.recharge}</p>
                        </div>
                        <div class="flex justify-between text-xs border-t border-indigo-200 pt-2">
                            <div class="text-gray-600">
                                <span class="block">ব্যালেন্স কাটবে: <span class="font-bold text-red-500">৳ ${preview.totalDeductionFromBalance.toFixed(2)}</span></span>
                            </div>
                            <div class="text-right text-gray-600">
                                <span class="block">নিট লাভ: <span class="font-bold text-green-600 text-sm">৳ ${preview.profit.toFixed(2)}</span></span>
                            </div>
                        </div>
                        ${preview.change > 0 ? `
                        <div class="mt-3 bg-yellow-100 p-2 rounded-lg text-center border border-yellow-200">
                            <p class="text-[10px] font-bold text-yellow-800 uppercase">ফেরত দিন</p>
                            <p class="text-xl font-black text-yellow-700">৳ ${preview.change}</p>
                        </div>` : ''}
                        
                        <button onclick="submitDescoSale()" class="w-full mt-3 py-3 rounded-lg font-bold text-white shadow-lg flex items-center justify-center gap-2 ${state.isDueMode ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}">
                            <i class="fa-solid fa-save"></i> ${state.isDueMode ? 'বাকিতে সেভ করুন' : 'সেভ করুন'}
                        </button>
                    `;
                }
                html += `</div>`;
            } else {
                // Quick Buttons
                html += `<div>
                    <p class="text-[10px] text-gray-400 font-bold mb-2 ml-1">দ্রুত বাছাই করুন:</p>
                    <div class="grid grid-cols-3 gap-2">`;
                quickButtons.forEach(amt => {
                    html += `<button onclick="updateDescoInput('${amt}')" class="bg-white border border-gray-200 py-2 rounded font-bold text-gray-600 hover:bg-blue-50 hover:text-blue-600 text-sm shadow-sm">${amt}</button>`;
                });
                html += `</div></div>`;
            }

            html += `</div>`;
            container.innerHTML = html;
        }

        // --- UPDATED: Type Settings Logic with Desco Support ---
        function openTypeSettings(type) {
            document.getElementById('modal-type-settings').classList.remove('hidden');
            document.getElementById('type-settings-name').innerText = type;
            document.getElementById('setting-type-key').value = type;

            const settings = appData.typeSettings[type] || {};

            // Toggle visibility based on type
            if (type === 'Desco') {
                document.getElementById('settings-generic-fields').classList.add('hidden');
                document.getElementById('settings-desco-fields').classList.remove('hidden');
                
                // Load Desco specific values (with defaults)
                document.getElementById('setting-desco-fee').value = settings.customerFee || 10;
                document.getElementById('setting-desco-cost').value = settings.companyCost || 2.5;
                document.getElementById('setting-desco-min').value = settings.minRecharge || 100;
            } else {
                document.getElementById('settings-generic-fields').classList.remove('hidden');
                document.getElementById('settings-desco-fields').classList.add('hidden');

                // Load Generic values
                document.getElementById('setting-cashout-cost').value = settings.cashoutCost || '';
                document.getElementById('setting-send-cost').value = settings.sendCost || '';
                document.getElementById('setting-commission').value = settings.commission || '';
            }
        }

        function saveTypeSettings() {
            const type = document.getElementById('setting-type-key').value;
            let data = {};

            if (type === 'Desco') {
                data = {
                    customerFee: parseFloat(document.getElementById('setting-desco-fee').value) || 0,
                    companyCost: parseFloat(document.getElementById('setting-desco-cost').value) || 0,
                    minRecharge: parseFloat(document.getElementById('setting-desco-min').value) || 0
                };
            } else {
                data = {
                    cashoutCost: parseFloat(document.getElementById('setting-cashout-cost').value) || 0,
                    sendCost: parseFloat(document.getElementById('setting-send-cost').value) || 0,
                    commission: parseFloat(document.getElementById('setting-commission').value) || 0
                };
            }

            if(!appData.typeSettings) appData.typeSettings = {};
            appData.typeSettings[type] = data;

            saveData();
            closeModal('modal-type-settings');
            showToast(`${type} সেটিংস আপডেট হয়েছে`, "success");
        }

        function openAccountFormModal(id = null) { 
            document.getElementById('modal-account-form').classList.remove('hidden'); 
            const balanceLabel = document.querySelector('#initial-balance-div label'); 
            if(id) { 
                const acc = appData.accounts.find(a => a.id === id); 
                document.getElementById('account-form-title').innerText = "অ্যাকাউন্ট এডিট করুন"; 
                document.getElementById('account-id').value = acc.id; 
                document.getElementById('account-name').value = acc.name; 
                document.getElementById('account-type').value = acc.type || 'Desco'; // Set type
                document.getElementById('initial-balance-div').classList.remove('hidden'); 
                document.getElementById('account-initial-balance').value = acc.balance; 
                balanceLabel.innerText = "বর্তমান ব্যালেন্স (সংশোধন)"; 
            } else { 
                document.getElementById('account-form-title').innerText = "নতুন অ্যাকাউন্ট"; 
                document.getElementById('account-id').value = ''; 
                document.getElementById('account-name').value = ''; 
                document.getElementById('account-type').value = 'Desco'; // Default type
                document.getElementById('account-initial-balance').value = ''; 
                document.getElementById('initial-balance-div').classList.remove('hidden'); 
                balanceLabel.innerText = "শুরুর ব্যালেন্স"; 
            } 
        }

        function saveAccount() { 
            const id = document.getElementById('account-id').value; 
            const name = document.getElementById('account-name').value; 
            const type = document.getElementById('account-type').value; // Get Type
            const balanceVal = parseInt(document.getElementById('account-initial-balance').value) || 0; 
            
            if(!name) return; 
            
            if(id) { 
                const index = appData.accounts.findIndex(a => a.id == id); 
                appData.accounts[index].name = name; 
                appData.accounts[index].type = type; // Update type
                appData.accounts[index].balance = balanceVal; 
            } else { 
                appData.accounts.push({ id: Date.now(), name: name, type: type, balance: balanceVal }); 
                if(balanceVal > 0) addToHistory('নতুন অ্যাকাউন্ট', `${name} (${type}) যুক্ত হয়েছে`, 1, 0, balanceVal, 0); 
            } 
            saveData(); 
            closeModal('modal-account-form'); 
        }

        function deleteAccount(id) { if(confirm("ডিলিট করবেন?")) { appData.accounts = appData.accounts.filter(a => a.id !== id); saveData(); renderAccountsList(); } }
        function editAccount(id) { openAccountFormModal(id); }
        function openAccountTransactModal(id) { const acc = appData.accounts.find(a => a.id === id); document.getElementById('transact-account-id').value = acc.id; document.getElementById('transact-account-name').innerText = acc.name + " - লেনদেন"; document.getElementById('modal-account-transact').classList.remove('hidden'); }
        
        function submitAccountTransaction(type) { 
            const id = parseInt(document.getElementById('transact-account-id').value); 
            const amount = parseInt(document.getElementById('transact-amount').value); 
            const desc = document.getElementById('transact-desc').value || (type === 'deposit' ? 'জমা' : 'খরচ'); 
            
            if(!amount) return; 
            const acc = appData.accounts.find(a => a.id === id); 
            
            if(type === 'deposit') { 
                acc.balance += amount; 
                addToHistory('অ্যাকাউন্ট জমা', `${acc.name} - ${desc}`, 1, 0, amount, 0); 
            } else { 
                if(acc.balance < amount) { showToast("ব্যালেন্স কম!", "error"); return; } 
                
                // Deduct from Account
                acc.balance -= amount; 
                
                // Add to Cash (Transfer logic: Account -> Cash)
                appData.cash += amount;

                addToHistory('অ্যাকাউন্ট থেকে ক্যাশ', `${acc.name} - ${desc}`, 1, amount, 0, 0); 
            } 
            saveData(); 
            closeModal('modal-account-transact'); 
            renderAdminPanel(); // To show updated Cash
        }
        
        function openManageCashModal() { 
            // This function is now deprecated for opening modal, but logic is moved to view
            // keeping it empty or redirecting just in case
            switchDashboardView('cash');
        }
        function submitCashTransaction(type) { const amount = parseInt(document.getElementById('manage-cash-amount').value); const desc = document.getElementById('manage-cash-desc').value || (type === 'add' ? 'জমা' : 'উত্তোলন'); if(!amount) return; if (type === 'add') { appData.cash += amount; addToHistory('ম্যানুয়াল ক্যাশ জমা', desc, 1, 0, amount, 0); } else { if (appData.cash < amount) { showToast("ক্যাশ নেই!", "error"); return; } appData.cash -= amount; addToHistory('ক্যাশ উত্তোলন', desc, 1, 0, amount, 0); } saveData(); refreshUI(); showToast("লেনদেন সম্পন্ন হয়েছে", "success"); document.getElementById('manage-cash-amount').value = ''; document.getElementById('manage-cash-desc').value = ''; }
        function openItemModal(id = null) { document.getElementById('modal-item').classList.remove('hidden'); if(id) { const item = appData.items.find(i => i.id === id); document.getElementById('modal-item-title').innerText = "এডিট করুন"; document.getElementById('item-id').value = item.id; document.getElementById('item-name').value = item.name; document.getElementById('item-category').value = item.category; document.getElementById('item-docs').value = item.docs; document.getElementById('item-cost').value = item.cost; document.getElementById('item-price').value = item.price; document.getElementById('item-stock').value = item.stock; } else { document.getElementById('modal-item-title').innerText = "নতুন প্রোডাক্ট"; document.getElementById('item-id').value = ''; document.getElementById('item-name').value = ''; document.getElementById('item-category').value = ''; document.getElementById('item-docs').value = ''; document.getElementById('item-cost').value = ''; document.getElementById('item-price').value = ''; document.getElementById('item-stock').value = ''; } }
        function saveItem() { const id = document.getElementById('item-id').value; const newItem = { id: id ? parseInt(id) : Date.now(), name: document.getElementById('item-name').value, category: document.getElementById('item-category').value, docs: document.getElementById('item-docs').value, cost: parseInt(document.getElementById('item-cost').value), price: parseInt(document.getElementById('item-price').value), stock: parseInt(document.getElementById('item-stock').value) }; if (id) { const index = appData.items.findIndex(i => i.id == id); appData.items[index] = newItem; } else { appData.items.push(newItem); } saveData(); closeModal('modal-item'); }
        function deleteItem(id) { if(confirm("ডিলিট করবেন?")) { appData.items = appData.items.filter(i => i.id !== id); saveData(); renderAdminItems(); } }

        window.onload = function() {
            if(localStorage.getItem('nokshaData')) { appData = JSON.parse(localStorage.getItem('nokshaData')); }
            initMasterApp(MASTER_CONFIG);
            if(savedActiveConfig) { initActiveApp(JSON.parse(savedActiveConfig)); }
            checkAuthOnLoad();
        };
    </script>
<script>
/* --- UPDATED CLOCK TOGGLE LOGIC FOR MOBILE --- */
(function(){
 const clock=document.getElementById('main-clock-container');
 const btn=document.getElementById('clock-toggle-btn');
 if(!clock||!btn) return;

 function update(){
   if(window.innerWidth<=480){
     // মোবাইল মোডে ঘড়ি হেডারের ভেতর থাকবে না
     if(!clock.classList.contains('mobile-active')) {
        clock.classList.add('hidden');
        clock.classList.remove('lg:flex', 'absolute');
     }
     btn.style.display='inline-flex';
   }else{
     // ডেক্সটপ মোডে আগের মতো
     clock.classList.remove('mobile-active', 'hidden');
     clock.classList.add('lg:flex', 'absolute');
     btn.style.display='none';
   }
 }

 btn.onclick=(e)=>{
   e.stopPropagation();
   if(window.innerWidth<=480) {
      clock.classList.toggle('mobile-active');
      if(clock.classList.contains('mobile-active')) {
          clock.classList.remove('hidden');
      } else {
          clock.classList.add('hidden');
      }
   } else {
      clock.style.display = clock.style.display==='none' ? 'flex' : 'none';
   }
 };

 // ঘড়ির বাইরে ক্লিক করলে বন্ধ হয়ে যাবে (মোবাইল মোডে)
 document.addEventListener('click', (e) => {
    if(window.innerWidth <= 480 && clock.classList.contains('mobile-active')) {
        if(!clock.contains(e.target) && !btn.contains(e.target)) {
            clock.classList.remove('mobile-active');
            clock.classList.add('hidden');
        }
    }
 });

 window.addEventListener('resize', update);
 update();
})();
</script>
</body>
</html>